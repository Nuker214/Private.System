<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Enhanced Private System</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <!-- Socket.IO Client Library -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Roboto:wght@300;400;500;700&display=swap');
    
    :root {
      --primary-bg: #0a0a0a;
      --secondary-bg: #1a1a1a;
      --accent-color: #ff4500;
      --accent-secondary: #ff6b35;
      --text-primary: #ffffff;
      --text-secondary: #cccccc;
      --border-color: #333;
      --success-color: #00ff41;
      --warning-color: #ffaa00;
      --error-color: #ff0040;
    }

    /* Light Theme Variables */
    body.light-theme {
      --primary-bg: #f0f2f5;
      --secondary-bg: #ffffff;
      --accent-color: #007bff; /* Using a blue accent for light mode as an example */
      --accent-secondary: #0056b3;
      --text-primary: #333333;
      --text-secondary: #666666;
      --border-color: #e0e0e0;
      --success-color: #28a745; /* Green for light theme success */
      --warning-color: #ffc107; /* Yellow for light theme warning */
      --error-color: #dc3545;   /* Red for light theme error */
    }

    /* Adjust specific elements for light theme */
    body.light-theme .login-box {
      background: rgba(255, 255, 255, 0.95);
      border: 3px solid var(--accent-color);
      box-shadow: 0 0 30px rgba(0, 123, 255, 0.3);
    }
    body.light-theme .login-box h2 {
      background: linear-gradient(45deg, var(--accent-color), #333);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    body.light-theme .login-box input {
      background: rgba(240, 240, 240, 0.8);
      border: 2px solid var(--border-color);
      color: #333;
    }
    body.light-theme .toggle-container span, body.light-theme .time-date-box .date-display {
      color: var(--text-primary);
    }
    body.light-theme .dashboard-header {
      background: linear-gradient(135deg, var(--accent-color), var(--accent-secondary));
      color: white; /* Keep header text white for contrast */
    }
    body.light-theme .quick-btn {
      background: var(--accent-color);
      color: white;
    }
    body.light-theme .quick-btn:hover {
      background: var(--accent-secondary);
    }
    body.light-theme .dashboard-quickbar {
        background: var(--secondary-bg);
        border-color: var(--border-color);
    }
    body.light-theme .search-bar {
      background: var(--primary-bg);
      border-color: var(--border-color);
      color: var(--text-primary);
    }
    body.light-theme .search-btn {
      background: var(--accent-color);
    }
    body.light-theme .search-btn:hover {
        background: var(--accent-secondary);
    }
    body.light-theme .quickbar-time-info {
        background-color: var(--primary-bg);
        border-color: var(--border-color);
        color: var(--text-primary);
    }
    body.light-theme .panels-grid {
      border: none;
    }
    body.light-theme .panel {
      background: var(--secondary-bg);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
    }
    body.light-theme .panel-title {
      color: var(--accent-color);
    }
    body.light-theme .panel-controls .panel-btn {
      background: var(--secondary-bg);
      border-color: var(--border-color);
      color: var(--text-secondary);
    }
    body.light-theme .panel-controls .panel-btn:hover {
      background: var(--accent-color);
      color: white;
    }
    body.light-theme .calendar-cell {
      background: var(--primary-bg);
      color: var(--text-primary);
    }
    body.light-theme .calendar-cell:hover, body.light-theme .calendar-cell.today {
      background: var(--accent-color);
      color: white;
    }
    body.light-theme .log-entry {
      background: var(--primary-bg);
      border-left-color: var(--accent-color); /* Kept accent for log importance */
      color: var(--text-primary);
    }
    body.light-theme .log-time {
      color: var(--text-secondary);
    }
    body.light-theme .login-entry-container {
        background-color: var(--primary-bg);
    }
    body.light-theme .login-entry-container.success {
        border-left: 4px solid var(--success-color);
    }
    body.light-theme .login-entry-container.failed {
        border-left: 4px solid var(--error-color);
    }
    body.light-theme .error-log-entry.error { /* This rule is specific to .error class, adjusted below */
        border-left: 4px solid var(--error-color);
        background-color: var(--primary-bg);
        color: var(--text-primary);
    }

    /* Fixed styling for system update items to match theme */
    body.light-theme .system-update-item {
        background-color: var(--primary-bg); /* Match other list items */
        border-left: 4px solid var(--accent-secondary); /* Give it an accent */
        color: var(--text-primary); /* Ensure text color adapts */
    }

    body.light-theme .notification {
      background: var(--secondary-bg);
      border: 2px solid var(--success-color); /* Accent border to signify its status */
      color: var(--text-primary); /* Should contrast well with bg */
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); /* Lighter shadow */
    }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    .panels-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
      transition: opacity 0.3s ease-in-out;
    }

    .panel {
      background: var(--secondary-bg);
      border: 1px solid var(--border-color);
      border-radius: 15px;
      padding: 20px;
      position: relative;
      transition: all 0.3s ease;
      resize: both;
      overflow: auto;
      min-height: 200px;
    }

    .panel:hover {
      box-shadow: 0 5px 20px rgba(255, 69, 0, 0.2);
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border-color);
    }

    .panel-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--accent-color);
    }

    .panel-controls {
      display: flex;
      gap: 5px;
    }

    .panel-btn {
      background: none;
      border: 1px solid var(--border-color);
      color: var(--text-secondary);
      border-radius: 4px;
      width: 25px;
      height: 25px;
      cursor: pointer;
      font-size: 10px;
      transition: all 0.3s ease;
    }

    .panel-btn:hover {
      background: var(--accent-color);
      color: white;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
      margin-top: 15px;
    }

    .calendar-cell {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--primary-bg);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 12px;
    }

    .calendar-cell:hover {
      background: var(--accent-color);
    }

    .calendar-cell.today {
      background: var(--accent-color);
      color: white;
      font-weight: bold;
    }

    /* Login History Entries */
    .login-entry-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        margin-bottom: 5px;
        border-radius: 6px;
        font-size: 12px;
        border: 1px solid var(--border-color);
        background-color: var(--primary-bg);
        transition: background-color 0.3s ease;
    }
    .login-entry-container.success {
        border-left: 4px solid var(--success-color);
        background-color: var(--primary-bg); /* Use primary for list item backgrounds */
    }
    .login-entry-container.failed {
        border-left: 4px solid var(--error-color);
        background-color: var(--primary-bg); /* Use primary for list item backgrounds */
    }
    .login-entry-status {
        font-weight: bold;
        color: var(--text-primary);
    }
    .login-entry-time {
        color: var(--text-secondary);
        font-size: 10px;
    }

    /* Important Dates styling */
    .important-date-input, .important-date-event-input {
        width: 100%;
        padding: 8px 10px;
        margin-bottom: 8px;
        border-radius: 6px;
        border: 1px solid var(--border-color);
        background-color: var(--primary-bg); /* Added background color */
        color: var(--text-primary);
        font-size: 14px;
        transition: border-color 0.3s ease;
    }
    .important-date-input:focus, .important-date-event-input:focus {
        outline: none;
        border-color: var(--accent-color);
    }
    .important-date-item {
        padding: 8px 10px;
        margin-bottom: 8px;
        border-radius: 6px;
        background-color: var(--primary-bg); /* Added background color */
        border-left: 4px solid var(--accent-secondary); /* Accent for visual interest */
        color: var(--text-primary);
        font-size: 13px;
        display: flex;
        flex-direction: column;
        gap: 2px;
    }
    .important-date-item .date-time {
        font-weight: bold;
        color: var(--accent-color);
    }
    .important-date-item .event-description {
        color: var(--text-secondary);
    }


    /* System Updates Panel Styling */
    .system-update-item {
        padding: 8px;
        border-radius: 6px;
        margin-bottom: 8px;
        font-size: 12px;
        background-color: var(--primary-bg); /* Apply theme-adaptive background */
        border-left: 4px solid var(--accent-secondary); /* Give it a subtle accent border */
        color: var(--text-primary); /* Ensure text color adapts */
        transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
    }


    /* Settings Modal */
    .settings-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }

    .settings-content {
      background: var(--secondary-bg);
      border: 2px solid var(--accent-color);
      border-radius: 20px;
      padding: 30px;
      width: 90%;
      max-width: 800px;
      max-height: 80vh;
      overflow-y: auto;
    }

    .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .setting-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background: var(--primary-bg);
      border-radius: 10px;
      border: 1px solid var(--border-color);
    }

    /* Drawing Tools */
    .drawing-tools {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
      padding: 15px;
      background: var(--primary-bg);
      border-radius: 10px;
    }

    .tool-btn {
      padding: 8px 12px;
      background: var(--accent-color);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.3s ease;
    }

    .tool-btn:hover, .tool-btn.active {
      background: var(--accent-secondary);
      transform: scale(1.05);
    }

    .color-picker {
      width: 30px;
      height: 30px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    .thickness-slider {
      width: 100px;
      accent-color: var(--accent-color);
    }

    /* Timer/Stopwatch */
    .timer-display {
      font-family: 'Orbitron', monospace;
      font-size: 36px;
      font-weight: 700;
      color: var(--accent-color);
      text-align: center;
      margin: 20px 0;
    }

    .timer-controls {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 15px;
    }

    /* Activity Logs */
    .log-entry {
      padding: 10px;
      background: var(--primary-bg);
      border-left: 4px solid var(--accent-color);
      margin-bottom: 10px;
      border-radius: 6px;
      font-size: 12px;
      display: flex;
      justify-content: space-between;
    }

    .log-time {
      color: var(--text-secondary);
      font-size: 10px;
    }

    /* Error Log Entries */
    .error-log-entry {
        padding: 10px;
        background: var(--primary-bg); /* Added background color */
        border-left: 4px solid var(--error-color);
        margin-bottom: 10px;
        border-radius: 6px;
        font-size: 12px;
        display: flex;
        justify-content: space-between;
        color: var(--text-primary);
    }
    .error-log-time {
        color: var(--text-secondary);
        font-size: 10px;
    }


    /* Stats Display */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .stat-item {
      text-align: center;
      padding: 15px;
      background: var(--primary-bg);
      border-radius: 10px;
      border: 1px solid var(--border-color);
    }

    .stat-number {
      font-family: 'Orbitron', monospace;
      font-size: 24px;
      font-weight: 700;
      color: var(--accent-color);
    }

    .stat-label {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 5px;
    }

    /* Themes */
    .theme-selector {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 10px;
      margin-top: 15px;
    }

    .theme-option {
      aspect-ratio: 1;
      border-radius: 10px;
      cursor: pointer;
      border: 3px solid transparent;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
    }

    .theme-option:hover, .theme-option.active {
      border-color: var(--accent-color);
      transform: scale(1.05);
    }

    /* Calculator */
    .calculator {
      background: var(--primary-bg);
      border-radius: 15px;
      padding: 20px;
      margin-top: 15px;
    }

    .calc-display {
      background: var(--secondary-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 15px;
      text-align: right;
      font-family: 'Orbitron', monospace;
      font-size: 24px;
      color: var(--accent-color);
      margin-bottom: 15px;
      min-height: 60px;
    }

    .calc-buttons {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }

    .calc-btn {
      aspect-ratio: 1;
      border: none;
      border-radius: 8px;
      background: var(--secondary-bg);
      color: white;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .calc-btn:hover {
      background: var(--accent-color);
    }

    .calc-btn.operator {
      background: var(--accent-color);
    }

    .calc-btn.equals {
      background: var(--success-color);
      color: black;
    }

    /* Media Player */
    .media-container {
      background: var(--primary-bg);
      border-radius: 15px;
      padding: 20px;
      margin-top: 15px;
    }

    .media-input {
      width: 100%;
      padding: 10px;
      background: var(--secondary-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      color: white;
      margin-bottom: 15px;
    }

    .media-frame {
      width: 100%;
      height: 400px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background: var(--secondary-bg);
    }

    /* Keybinds */
    .keybind-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background: var(--primary-bg);
      border-radius: 8px;
      margin-bottom: 10px;
    }

    .keybind-input {
      background: var(--secondary-bg);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      padding: 5px 10px;
      color: white;
      font-family: 'Courier New', monospace;
    }

    /* Clicker Button */
    .click-button {
        width: 100%;
        padding: 15px;
        background: var(--accent-color); /* Matches quick-btn */
        color: white;
        font-size: 18px;
        font-weight: 700;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-top: 10px;
    }
    .click-button:hover {
        background: var(--accent-secondary);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(var(--accent-color), 0.4);
    }
    .click-count-display {
        font-family: 'Orbitron', monospace;
        font-size: 48px;
        font-weight: 900;
        color: var(--accent-color);
        text-align: center;
        margin-bottom: 20px;
        padding: 10px;
        background-color: var(--primary-bg); /* Add background */
        border-radius: 10px;
        border: 1px solid var(--border-color);
    }

    /* Daily Quotes & Random Facts content styling */
    #randomFact, #dailyQuote {
        background-color: var(--primary-bg); /* Background for text content */
        padding: 15px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        line-height: 1.5;
        font-style: italic;
        color: var(--text-primary);
    }

    /* Announcement Bar */
    .announcement-bar {
      background-color: var(--secondary-bg);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      padding: 10px 20px;
      overflow: hidden; /* Crucial for the moving text */
      margin-bottom: 20px; /* Space between announcement and panels */
      position: relative;
    }

    .announcement-content {
      white-space: nowrap; /* Keep text on a single line */
      display: inline-block; /* Essential for animation */
      padding-left: 100%; /* Start the text off-screen to the right */
      color: var(--accent-color); /* Make the text stand out */
      font-weight: bold;
      animation: marquee 20s linear infinite; /* Adjust time as needed for speed */
    }

    @keyframes marquee {
      0% { transform: translateX(0%); }
      100% { transform: translateX(-100%); } /* Move fully to the left */
    }

    /* Reset Popup styles */
    .reset-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(26, 26, 26, 0.98);
      backdrop-filter: blur(10px);
      border: 3px solid var(--accent-color);
      border-radius: 15px;
      padding: 30px;
      text-align: center;
      z-index: 1001; /* Above login box */
      box-shadow: 0 0 40px rgba(255, 69, 0, 0.6);
      width: 350px;
      max-width: 90%;
      display: none; /* Hidden by default */
    }

    .reset-popup p {
      margin-bottom: 20px;
      font-size: 1.1em;
      color: var(--text-primary);
    }

    .reset-popup .reset-field {
      width: 100%;
      padding: 12px;
      margin-bottom: 20px;
      border-radius: 8px;
      border: 2px solid var(--border-color);
      background: var(--primary-bg);
      color: var(--text-primary);
      font-size: 16px;
      text-align: center;
    }

    .reset-popup button {
      width: 100%;
      padding: 12px;
      background: linear-gradient(45deg, var(--accent-color), var(--accent-secondary));
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      transition: all 0.3s ease;
    }

    .reset-popup button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255, 69, 0, 0.3);
    }


    /* Responsive */
    @media (max-width: 1200px) {
        .dashboard-quickbar .search-group {
            flex-direction: column; /* Stack search bar and time info on smaller screens */
            max-width: 100%;
            align-items: flex-start; /* Align text left */
        }
        .dashboard-quickbar .quickbar-time-info {
            width: 100%;
            justify-content: space-between;
        }
        .dashboard-quickbar .quick-btn-group {
            width: 100%; /* Make buttons take full width when stacked */
            justify-content: center;
        }
        .search-container {
            max-width: 100%;
        }
    }
    @media (max-width: 768px) {
      .login-box {
        width: 90%;
        margin: 20px auto;
      }
      
      .panels-grid {
        grid-template-columns: 1fr;
      }
      
    }
    @media (max-width: 640px) { /* Even smaller screens for dashboard-quickbar */
        .dashboard-quickbar {
            flex-direction: column;
            gap: 10px;
            align-items: flex-start;
        }
        .search-group, .quick-btn-group {
            width: 100%;
        }
        .quick-btn-group {
             justify-content: center; /* Center buttons if wrapped */
        }
    }

    /* Loading Animation */
    .loading-cube {
      width: 60px;
      height: 60px;
      position: relative;
      transform-style: preserve-3d;
      animation: loadingRotate 1.5s infinite linear;
    }

    .loading-face {
      position: absolute;
      width: 60px;
      height: 60px;
      background: linear-gradient(45deg, var(--accent-color), var(--accent-secondary));
      border: 1px solid #fff;
      opacity: 0.9;
    }

    .loading-face.front { transform: rotateY(0deg) translateZ(30px); }
    .loading-face.back { transform: rotateY(180deg) translateZ(30px); }
    .loading-face.right { transform: rotateY(90deg) translateZ(30px); }
    .loading-face.left { transform: rotateY(-90deg) translateZ(30px); }
    .loading-face.top { transform: rotateX(90deg) translateZ(30px); }
    .loading-face.bottom { transform: rotateX(-90deg) translateZ(30px); }

    @keyframes loadingRotate {
      0% { transform: rotateX(0deg) rotateY(0deg); }
      100% { transform: rotateX(360deg) rotateY(360deg); }
    }

    /* Hidden by default */
    .hidden { display: none !important; }
  </style>
</head>
<body>

<!-- Initialization Screen -->
<div id="initScreen" class="init-screen">
  <div class="rotating-cube">
    <div class="cube-face front"></div>
    <div class="cube-face back"></div>
    <div class="cube-face right"></div>
    <div class="cube-face left"></div>
    <div class="cube-face top"></div>
    <div class="cube-face bottom"></div>
  </div>
  <div id="initText" class="init-text">Initializing System...</div>
  <div class="code-rain" id="codeRain"></div>
</div>

<!-- Login Screen -->
<div id="loginScreen" class="login-container hidden">
  <div class="login-quickbar">
    <div class="flex items-center gap-2">
      <button class="panic-btn" onclick="sendPanicSignal('https://clever.com')">
        <i class="fas fa-exclamation-triangle"></i> Panic
      </button>
    </div>
    <div class="flex items-center gap-2">
      <button onclick="adjustZoom(0.1)"><i class="fas fa-search-plus"></i> Zoom In</button>
      <button onclick="adjustZoom(-0.1)"><i class="fas fa-search-minus"></i> Zoom Out</button>
    </div>
  </div>

  <div class="login-box" id="loginBox">
    <h2><i class="fas fa-shield-alt"></i> Private System</h2>
    
    <div class="input-group">
      <input type="text" id="username" placeholder="Enter Username..." autocomplete="off">
    </div>
    
    <div class="input-group">
      <input type="password" id="password" placeholder="Enter Password..." autocomplete="off">
    </div>
    
    <div class="input-group">
      <input type="text" id="userID" placeholder="Enter User Identifier..." autocomplete="off">
    </div>

    <div class="toggle-container">
      <span>Show Password</span>
      <div class="toggle-switch" id="showPasswordToggle">
        <div class="toggle-slider"></div>
      </div>
    </div>

    <button class="submit-btn" id="submitBtn">
      <i class="fas fa-sign-in-alt"></i> ACCESS SYSTEM
    </button>

    <div id="errorMsg" class="text-red-400 mt-4 text-sm"></div>
    <div id="attemptsText" class="text-yellow-400 mt-2 text-sm">Attempts Left: 5</div>
  </div>

  <div class="time-date-box">
    <div class="time-display" id="currentTime">00:00:00</div>
    <div class="date-display" id="currentDate">Loading...</div>
    <div class="toggle-container mt-4">
      <span>24-Hour Format</span>
      <div class="toggle-switch" id="timeFormatToggle">
        <div class="toggle-slider"></div>
      </div>
    </div>
  </div>

  <!-- Reset Counter Popup (initially hidden) -->
  <div id="resetPopup" class="reset-popup" role="dialog" aria-modal="true" aria-hidden="true">
    <p>System Locked. Enter reset code to continue:</p>
    <input type="password" id="resetField" class="reset-field" placeholder="Enter Reset Code...">
    <button id="resetBtn">Reset Attempts</button>
  </div>

</div>

<!-- Loading Screen -->
<div id="loadingScreen" class="init-screen hidden">
  <div class="loading-cube">
    <div class="cube-face front"></div>
    <div class="cube-face back"></div>
    <div class="cube-face right"></div>
    <div class="cube-face left"></div>
    <div class="cube-face top"></div>
    <div class="cube-face bottom"></div>
  </div>
  <div class="init-text">Loading Dashboard...</div>
  <div class="code-rain" id="loadingCodeRain"></div>
</div>

<!-- Dashboard -->
<div id="dashboard" class="dashboard">
  <!-- Welcome Notification -->
  <div id="welcomeNotification" class="notification">
    <i class="fas fa-user-check"></i> Welcome <span id="loggedUser">User</span>!
  </div>

  <!-- Dashboard Header -->
  <div class="dashboard-header">
    <div>
      <h1 class="text-2xl font-bold"><i class="fas fa-tachometer-alt"></i> Enhanced Private Dashboard</h1>
      <p class="text-sm opacity-80">User: <span id="currentUser">Beta.user</span> | ID: <span id="currentUserID">281573</span></p>
      <div class="text-xs mt-1">Status: <span id="connectionStatus" class="text-green-300"></span></div>
    </div>
    <div class="bg-white text-black px-4 py-2 rounded-lg font-bold">
      Version 2.0.0
    </div>
  </div>

  <!-- Quick Bar with Search, Session Time, Real Time, and Buttons -->
  <div class="dashboard-quickbar">
    <!-- Left Section: Search and Time Displays -->
    <div class="search-group">
        <div class="search-container">
            <input type="text" class="search-bar" id="searchBar" placeholder="Search panels, features...">
            <button class="search-btn" onclick="performSearch()"><i class="fas fa-search"></i></button>
        </div>
        <div class="quickbar-time-info">Session Time: <span id="quickbarSessionTime" class="quickbar-time-value">00:00:00</span></div>
        <div class="quickbar-time-info">Real Time: <span id="quickbarCurrentTime" class="quickbar-time-value">00:00:00</span></div>
    </div>
    
    <!-- Right Section: All other buttons -->
    <div class="quick-btn-group">
      <button class="quick-btn" onclick="togglePanel('settingsModal')">
        <i class="fas fa-cog"></i> Settings
      </button>
      <button class="quick-btn" onclick="togglePanel('timerPanel')">
        <i class="fas fa-stopwatch"></i> Timer
      </button>
      <button class="quick-btn" onclick="togglePanel('notesPanel')">
        <i class="fas fa-pen"></i> Notes
      </button>
      <button class="quick-btn" onclick="showStats()">
        <i class="fas fa-chart-bar"></i> Stats
      </button>
      <button class="quick-btn" onclick="takeScreenshot()">
          <i class="fas fa-camera"></i> Screenshot
      </button>
      <button class="quick-btn" onclick="togglePanelsGridVisibility()">
          <i class="fas fa-toggle-on"></i> Toggle Sections
      </button>
      <button class="quick-btn" onclick="adjustZoom(0.1)">
          <i class="fas fa-search-plus"></i> Zoom In
      </button>
      <button class="quick-btn" onclick="adjustZoom(-0.1)">
          <i class="fas fa-search-minus"></i> Zoom Out
      </button>
      <button class="quick-btn" onclick="restartSystem()">
          <i class="fas fa-redo-alt"></i> Restart
      </button>
      <button class="quick-btn panic-btn" onclick="sendPanicSignal('https://clever.com')">
          <i class="fas fa-exclamation-triangle"></i> Panic
      </button>
      <button class="quick-btn" onclick="toggleTheme()">
        <i class="fas fa-palette"></i> Theme
      </button>
      <button class="quick-btn" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i> Logout
      </button>
    </div>
  </div>

  <!-- Announcement Bar (newly added) -->
  <div class="announcement-bar mt-4">
      <div class="announcement-content">
          <p id="announcementText">Important System Announcement: Scheduled maintenance this weekend. System may experience brief interruptions. Please save your work regularly!</p>
      </div>
  </div>

  <!-- Main Panels Grid -->
  <div class="panels-grid" id="panelsGrid">
    <!-- Calendar Panel -->
    <div class="panel" data-panel="calendar">
      <div class="panel-header">
        <div class="panel-title"><i class="fas fa-calendar"></i> Calendar</div>
        <div class="panel-controls">
          <button class="panel-btn" onclick="minimizePanel(this)"><i class="fas fa-minus"></i></button>
          <button class="panel-btn" onclick="closePanel(this)"><i class="fas fa-times"></i></button>
        </div>
      </div>
      <div class="calendar-grid" id="calendarGrid">
        <!-- Calendar will be generated here -->
      </div>
    </div>

    <!-- Important Dates Panel -->
    <div class="panel" data-panel="importantDates">
      <div class="panel-header">
        <div class="panel-title"><i class="fas fa-star"></i> Important Dates</div>
        <div class="panel-controls">
          <button class="panel-btn" onclick="clearImportantDates()"><i class="fas fa-trash"></i></button>
          <button class="panel-btn" onclick="closePanel(this)"><i class="fas fa-times"></i></button>
        </div>
      </div>
      <div class="content">
        <input type="date" id="importantDateDay" class="important-date-input" value="2025-08-24">
        <input type="time" id="importantDateTime" class="important-date-input" value="09:00">
        <input type="text" id="importantDateEvent" class="important-date-event-input" placeholder="Event Description...">
        <button class="quick-btn w-full mt-2" onclick="addImportantDate()">Add Event</button>
        <div id="importantDatesList" class="mt-4 max-h-40 overflow-y-auto space-y-2">
            <!-- Important dates will be populated here -->
        </div>
      </div>
    </div>

    <!-- Random Facts Panel -->
    <div class="panel" data-panel="facts">
      <div class="panel-header">
        <div class="panel-title"><i class="fas fa-lightbulb"></i> Random Facts</div>
        <div class="panel-controls">
          <button class="panel-btn" onclick="refreshFact()"><i class="fas fa-sync"></i></button>
          <button class="panel-btn" onclick="closePanel(this)"><i class="fas fa-times"></i></button>
        </div>
      </div>
      <div id="randomFact" class="text-sm">
        Did you know? The human brain contains approximately 86 billion neurons!
      </div>
    </div>

    <!-- Daily Quotes Panel -->
    <div class="panel" data-panel="quotes">
      <div class="panel-header">
        <div class="panel-title"><i class="fas fa-quote-left"></i> Daily Quote</div>
        <div class="panel-controls">
          <button class="panel-btn" onclick="refreshQuote()"><i class="fas fa-sync"></i></button>
          <button class="panel-btn" onclick="closePanel(this)"><i class="fas fa-times"></i></button>
        </div>
      </div>
      <div id="dailyQuote" class="text-sm italic">
        "The only way to do great work is to love what you do." - Steve Jobs
      </div>
    </div>

    <!-- Updates Panel -->
    <div class="panel" data-panel="updates">
      <div class="panel-header">
        <div class="panel-title"><i class="fas fa-sync-alt"></i> System Updates</div>
        <div class="panel-controls">
          <button class="panel-btn" onclick="closePanel(this)"><i class="fas fa-times"></i></button>
        </div>
      </div>
      <div class="space-y-2" id="systemUpdatesList">
        <div class="system-update-item">Enhanced UI v2.0 Deployed</div>
        <div class="system-update-item">New Security Features Added</div>
        <div class="system-update-item">Performance Optimizations</div>
      </div>
    </div>

    <!-- Notifications Panel -->
    <div class="panel" data-panel="notifications">
      <div class="panel-header">
        <div class="panel-title"><i class="fas fa-bell"></i> Notifications</div>
        <div class="panel-controls">
          <button class="panel-btn" onclick="clearNotifications()"><i class="fas fa-trash"></i></button>
          <button class="panel-btn" onclick="closePanel(this)"><i class="fas fa-times"></i></button>
        </div>
      </div>
      <div id="notificationsList" class="space-y-2">
        <div class="p-2 bg-blue-900 rounded text-xs">System initialized successfully</div>
        <div class="p-2 bg-green-900 rounded text-xs">All security checks passed</div>
      </div>
    </div>

    <!-- Activity Logs Panel -->
    <div class="panel" data-panel="activityLogs">
      <div class="panel-header">
        <div class="panel-title"><i class="fas fa-list"></i> Activity Logs</div>
        <div class="panel-controls">
          <button class="panel-btn" onclick="downloadActivityLogs()"><i class="fas fa-download"></i></button>
          <button class="panel-btn" onclick="clearActivityLogs()"><i class="fas fa-trash"></i></button>
          <button class="panel-btn" onclick="closePanel(this)"><i class="fas fa-times"></i></button>
        </div>
      </div>
      <div id="activityLogsList" class="max-h-40 overflow-y-auto">
        <!-- Activity logs will be populated here -->
      </div>
    </div>

    <!-- Error Log Panel -->
    <div class="panel" data-panel="errorLog">
      <div class="panel-header">
        <div class="panel-title"><i class="fas fa-bug"></i> Error Log</div>
        <div class="panel-controls">
          <button class="panel-btn" onclick="downloadErrorLogs()"><i class="fas fa-download"></i></button>
          <button class="panel-btn" onclick="clearErrorLogs()"><i class="fas fa-trash"></i></button>
          <button class="panel-btn" onclick="closePanel(this)"><i class="fas fa-times"></i></button>
        </div>
      </div>
      <div id="errorLogsList" class="max-h-40 overflow-y-auto space-y-2">
        <!-- Error logs will be populated here -->
      </div>
    </div>

    <!-- Login History Panel -->
    <div class="panel" data-panel="loginHistory">
      <div class="panel-header">
        <div class="panel-title"><i class="fas fa-history"></i> Login History</div>
        <div class="panel-controls">
          <button class="panel-btn" onclick="closePanel(this)"><i class="fas fa-times"></i></button>
        </div>
      </div>
      <div id="loginHistoryList" class="space-y-2 max-h-40 overflow-y-auto">
        <!-- Login history will be populated here -->
      </div>
    </div>

    <!-- Mouse Clicker Panel -->
    <div class="panel" data-panel="mouseClicker">
      <div class="panel-header">
        <div class="panel-title"><i class="fas fa-mouse-pointer"></i> Mouse Clicker</div>
        <div class="panel-controls">
          <button class="panel-btn" onclick="closePanel(this)"><i class="fas fa-times"></i></button>
        </div>
      </div>
      <div class="content">
        <div id="clickCountDisplay" class="click-count-display">0</div>
        <button class="click-button" onclick="incrementClickCounter()">Click Me!</button>
        <div class="mouse-clicker-controls">
            <button class="quick-btn mt-2" onclick="resetClickCounter()"><i class="fas fa-undo-alt"></i> Reset</button>
        </div>
      </div>
    </div>

  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="settings-modal">
    <div class="settings-content">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-orange-500"><i class="fas fa-cog"></i> System Settings</h2>
        <button onclick="togglePanel('settingsModal')" class="text-2xl text-gray-400 hover:text-white">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="settings-grid">
        <div class="setting-item">
          <span>Dark Mode</span>
          <div class="toggle-switch" onclick="toggleSetting(this)">
            <div class="toggle-slider"></div>
          </div>
        </div>
        <div class="setting-item">
          <span>Auto-save Notes</span>
          <div class="toggle-switch active" onclick="toggleSetting(this)">
            <div class="toggle-slider"></div>
          </div>
        </div>
        <div class="setting-item">
          <span>Sound Notifications</span>
          <div class="toggle-switch" onclick="toggleSetting(this)">
            <div class="toggle-slider"></div>
          </div>
        </div>
        <div class="setting-item">
          <span>Auto-refresh Data</span>
          <div class="toggle-switch active" onclick="toggleSetting(this)">
            <div class="toggle-slider"></div>
          </div>
        </div>
        <div class="setting-item">
          <span>Compact View</span>
          <div class="toggle-switch" onclick="toggleSetting(this)">
            <div class="toggle-slider"></div>
          </div>
        </div>
        <div class="setting-item">
          <span>Show Animations</span>
          <div class="toggle-switch active" onclick="toggleSetting(this)">
            <div class="toggle-slider"></div>
          </div>
        </div>
        <div class="setting-item">
          <span>High Contrast</span>
          <div class="toggle-switch" onclick="toggleSetting(this)">
            <div class="toggle-slider"></div>
          </div>
        </div>
        <div class="setting-item">
          <span>Auto-backup</span>
          <div class="toggle-switch active" onclick="toggleSetting(this)">
            <div class="toggle-slider"></div>
          </div>
        </div>
        <div class="setting-item">
          <span>Security Mode</span>
          <div class="toggle-switch active" onclick="toggleSetting(this)">
            <div class="toggle-slider"></div>
          </div>
        </div>
        <div class="setting-item">
          <span>Advanced Logging</span>
          <div class="toggle-switch" onclick="toggleSetting(this)">
            <div class="toggle-slider"></div>
          </div>
        </div>
        <div class="setting-item">
          <span>Performance Mode</span>
          <div class="toggle-switch" onclick="toggleSetting(this)">
            <div class="toggle-slider"></div>
          </div>
        </div>
        <div class="setting-item">
          <span>Developer Mode</span>
          <div class="toggle-switch" onclick="toggleSetting(this)">
            <div class="toggle-slider"></div>
          </div>
        </div>
        <div class="setting-item">
          <span>Experimental Features</span>
          <div class="toggle-switch" onclick="toggleSetting(this)">
            <div class="toggle-slider"></div>
          </div>
        </div>
        <div class="setting-item">
          <span>Data Compression</span>
          <div class="toggle-switch active" onclick="toggleSetting(this)">
            <div class="toggle-slider"></div>
          </div>
        </div>
        <div class="setting-item">
          <span>Real-time Sync</span>
          <div class="toggle-switch" onclick="toggleSetting(this)">
            <div class="toggle-slider"></div>
          </div>
        </div>
      </div>

      <!-- Keybinds Section -->
      <div class="mt-8">
        <h3 class="text-xl font-bold text-orange-500 mb-4"><i class="fas fa-keyboard"></i> Keybinds Configuration</h3>
        <div class="space-y-3" id="keybindsList">
          <div class="keybind-item">
            <span>Open Settings</span>
            <input type="text" class="keybind-input" value="Ctrl+," placeholder="Press keys...">
          </div>
          <div class="keybind-item">
            <span>Quick Search</span>
            <input type="text" class="keybind-input" value="Ctrl+K" placeholder="Press keys...">
          </div>
          <div class="keybind-item">
            <span>New Note</span>
            <input type="text" class="keybind-input" value="Ctrl+N" placeholder="Press keys...">
          </div>
          <div class="keybind-item">
            <span>Save All</span>
            <input type="text" class="keybind-input" value="Ctrl+S" placeholder="Press keys...">
          </div>
          <div class="keybind-item">
            <span>Toggle Theme</span>
            <input type="text" class="keybind-input" value="Ctrl+T" placeholder="Press keys...">
          </div>
        </div>
      </div>

      <!-- Theme Selector -->
      <div class="mt-8">
        <h3 class="text-xl font-bold text-orange-500 mb-4"><i class="fas fa-palette"></i> Accent Theme Selection</h3>
        <div class="theme-selector">
          <div class="theme-option active" style="background: linear-gradient(135deg, #ff4500, #ff6b35);" onclick="applyAccentTheme('orange', event)">Orange</div>
          <div class="theme-option" style="background: linear-gradient(135deg, #0066cc, #004499);" onclick="applyAccentTheme('blue', event)">Blue</div>
          <div class="theme-option" style="background: linear-gradient(135deg, #00cc44, #009933);" onclick="applyAccentTheme('green', event)">Green</div>
          <div class="theme-option" style="background: linear-gradient(135deg, #cc0044, #990033);" onclick="applyAccentTheme('red', event)">Red</div>
          <div class="theme-option" style="background: linear-gradient(135deg, #8800cc, #6600aa);" onclick="applyAccentTheme('purple', event)">Purple</div>
          <div class="theme-option" style="background: linear-gradient(135deg, #ffaa00, #ff8800);" onclick="applyAccentTheme('amber', event)">Amber</div>
          <div class="theme-option" style="background: linear-gradient(135deg, #00aaaa, #008888);" onclick="applyAccentTheme('teal', event)">Teal</div>
          <div class="theme-option" style="background: linear-gradient(135deg, #ff0088, #cc0066);" onclick="applyAccentTheme('pink', event)">Pink</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Timer Panel -->
  <div id="timerPanel" class="settings-modal">
    <div class="settings-content">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-orange-500"><i class="fas fa-stopwatch"></i> Timer & Stopwatch</h2>
        <button onclick="togglePanel('timerPanel')" class="text-2xl text-gray-400 hover:text-white">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <!-- Stopwatch -->
        <div class="bg-gray-800 p-6 rounded-lg">
          <h3 class="text-lg font-bold mb-4 text-center">Stopwatch</h3>
          <div class="timer-display" id="stopwatchDisplay">00:00:00</div>
          <div class="timer-controls">
            <button class="tool-btn" onclick="startStopwatch()"><i class="fas fa-play"></i> Start</button>
            <button class="tool-btn" onclick="pauseStopwatch()"><i class="fas fa-pause"></i> Pause</button>
            <button class="tool-btn" onclick="resetStopwatch()"><i class="fas fa-stop"></i> Reset</button>
          </div>
        </div>

        <!-- Timer -->
        <div class="bg-gray-800 p-6 rounded-lg">
          <h3 class="text-lg font-bold mb-4 text-center">Countdown Timer</h3>
          <div class="timer-display" id="timerDisplay">00:00:00</div>
          <div class="flex justify-center gap-2 mb-4">
            <input type="number" id="timerHours" class="w-16 p-2 bg-gray-700 rounded text-center" placeholder="HH" min="0" max="23">
            <input type="number" id="timerMinutes" class="w-16 p-2 bg-gray-700 rounded text-center" placeholder="MM" min="0" max="59">
            <input type="number" id="timerSeconds" class="w-16 p-2 bg-gray-700 rounded text-center" placeholder="SS" min="0" max="59">
          </div>
          <div class="timer-controls">
            <button class="tool-btn" onclick="startTimer()"><i class="fas fa-play"></i> Start</button>
            <button class="tool-btn" onclick="pauseTimer()"><i class="fas fa-pause"></i> Pause</button>
            <button class="tool-btn" onclick="resetTimer()"><i class="fas fa-stop"></i> Reset</button>
          </div>
        </div>
      </div>

      <!-- Reminders -->
      <div class="mt-8">
        <h3 class="text-lg font-bold mb-4"><i class="fas fa-bell"></i> Reminders</h3>
        <div class="flex gap-2 mb-4">
          <input type="text" id="reminderText" class="flex-1 p-2 bg-gray-700 rounded" placeholder="Reminder text...">
          <input type="datetime-local" id="reminderTime" class="p-2 bg-gray-700 rounded">
          <button class="tool-btn" onclick="addReminder()"><i class="fas fa-plus"></i> Add</button>
        </div>
        <div id="remindersList" class="space-y-2">
          <!-- Reminders will be populated here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Notes Panel -->
  <div id="notesPanel" class="settings-modal">
    <div class="settings-content">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-orange-500"><i class="fas fa-pen"></i> Enhanced Notes</h2>
        <button onclick="togglePanel('notesPanel')" class="text-2xl text-gray-400 hover:text-white">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="drawing-tools">
        <button class="tool-btn active" data-tool="pen" onclick="selectTool(this, 'pen')">
          <i class="fas fa-pen"></i> Pen
        </button>
        <button class="tool-btn" data-tool="brush" onclick="selectTool(this, 'brush')">
          <i class="fas fa-paint-brush"></i> Brush
        </button>
        <button class="tool-btn" data-tool="eraser" onclick="selectTool(this, 'eraser')">
          <i class="fas fa-eraser"></i> Eraser
        </button>
        <button class="tool-btn" data-tool="text" onclick="selectTool(this, 'text')">
          <i class="fas fa-text-height"></i> Text
        </button>
        <button class="tool-btn" data-tool="line" onclick="selectTool(this, 'line')">
          <i class="fas fa-minus"></i> Line
        </button>
        <button class="tool-btn" data-tool="rectangle" onclick="selectTool(this, 'rectangle')">
          <i class="fas fa-square"></i> Rectangle
        </button>
        <button class="tool-btn" data-tool="circle" onclick="selectTool(this, 'circle')">
          <i class="fas fa-circle"></i> Circle
        </button>
        
        <div class="flex items-center gap-2">
          <label class="text-sm">Color:</label>
          <input type="color" id="penColor" class="color-picker" value="#ff4500">
        </div>
        
        <div class="flex items-center gap-2">
          <label class="text-sm">Thickness:</label>
          <input type="range" id="penThickness" class="thickness-slider" min="1" max="20" value="2">
        </div>
        
        <div class="flex items-center gap-2">
          <label class="text-sm">Material:</label>
          <select id="penMaterial" class="bg-gray-700 text-white p-1 rounded">
            <option value="solid">Solid</option>
            <option value="dashed">Dashed</option>
            <option value="dotted">D-otted</option>
          </select>
        </div>
        
        <button class="tool-btn" onclick="clearCanvas()">
          <i class="fas fa-trash"></i> Clear
        </button>
        <button class="tool-btn" onclick="saveCanvas()">
          <i class="fas fa-save"></i> Save
        </button>
      </div>
      
      <canvas id="drawingCanvas" width="760" height="400" class="w-full border border-gray-600 rounded mt-4 bg-white cursor-crosshair"></canvas>
      
      <!-- Text Notes Section -->
      <div class="mt-6">
        <h3 class="text-lg font-bold mb-2"><i class="fas fa-sticky-note"></i> Text Notes</h3>
        <textarea id="textNotes" class="w-full h-32 p-3 bg-gray-700 rounded resize-none" placeholder="Type your notes here..."></textarea>
        <div class="flex gap-2 mt-2">
          <button class="tool-btn" onclick="saveTextNotes()"><i class="fas fa-save"></i> Save Notes</button>
          <button class="tool-btn" onclick="clearTextNotes()"><i class="fas fa-trash"></i> Clear Notes</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Calculator Panel (Removed from quickbar, still available in code for direct call if needed) -->
  <div id="calculatorPanel" class="settings-modal" style="display:none;"> 
    <div class="settings-content">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-orange-500"><i class="fas fa-calculator"></i> Calculator & Converter</h2>
        <button onclick="togglePanel('calculatorPanel')" class="text-2xl text-gray-400 hover:text-white">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Calculator -->
        <div class="calculator">
          <h3 class="text-lg font-bold mb-4 text-center">Calculator</h3>
          <div class="calc-display" id="calcDisplay">0</div>
          <div class="calc-buttons">
            <button class="calc-btn" onclick="clearCalc()">C</button>
            <button class="calc-btn" onclick="deleteLast()"></button>
            <button class="calc-btn operator" onclick="appendToCalc('/')">/</button>
            <button class="calc-btn operator" onclick="appendToCalc('*')"></button>
            
            <button class="calc-btn" onclick="appendToCalc('7')">7</button>
            <button class="calc-btn" onclick="appendToCalc('8')">8</button>
            <button class="calc-btn" onclick="appendToCalc('9')">9</button>
            <button class="calc-btn operator" onclick="appendToCalc('-')">-</button>
            
            <button class="calc-btn" onclick="appendToCalc('4')">4</button>
            <button class="calc-btn" onclick="appendToCalc('5')">5</button>
            <button class="calc-btn" onclick="appendToCalc('6')">6</button>
            <button class="calc-btn operator" onclick="appendToCalc('+')">+</button>
            
            <button class="calc-btn" onclick="appendToCalc('1')">1</button>
            <button class="calc-btn" onclick="appendToCalc('2')">2</button>
            <button class="calc-btn" onclick="appendToCalc('3')">3</button>
            <button class="calc-btn equals" onclick="calculateResult()" rowspan="2">=</button>
            
            <button class="calc-btn" onclick="appendToCalc('0')" style="grid-column: span 2;">0</button>
            <button class="calc-btn" onclick="appendToCalc('.')">.</button>
          </div>
        </div>

        <!-- Unit Converter -->
        <div class="bg-gray-800 p-6 rounded-lg">
          <h3 class="text-lg font-bold mb-4 text-center">Unit Converter</h3>
          <div class="space-y-4">
            <select id="conversionType" class="w-full p-2 bg-gray-700 rounded" onchange="updateConversionUnits()">
              <option value="length">Length</option>
              <option value="weight">Weight</option>
              <option value="temperature">Temperature</option>
              <option value="volume">Volume</option>
            </select>
            
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm mb-1">From:</label>
                <select id="fromUnit" class="w-full p-2 bg-gray-700 rounded">
                  <option value="m">Meters</option>
                  <option value="km">Kilometers</option>
                  <option value="cm">Centimeters</option>
                  <option value="mm">Millimeters</option>
                  <option value="in">Inches</option>
                  <option value="ft">Feet</option>
                </select>
                <input type="number" id="fromValue" class="w-full p-2 bg-gray-700 rounded mt-2" placeholder="Enter value" oninput="convertUnits()">
              </div>
              
              <div>
                <label class="block text-sm mb-1">To:</label>
                <select id="toUnit" class="w-full p-2 bg-gray-700 rounded" onchange="convertUnits()">
                  <option value="m">Meters</option>
                  <option value="km">Kilometers</option>
                  <option value="cm">Centimeters</option>
                  <option value="mm">Millimeters</option>
                  <option value="in">Inches</option>
                  <option value="ft">Feet</option>
                </select>
                <input type="number" id="toValue" class="w-full p-2 bg-gray-700 rounded mt-2" readonly>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Media Panel (Removed from quickbar, still available in code for direct call if needed) -->
  <div id="mediaPanel" class="settings-modal" style="display:none;">
    <div class="settings-content">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-orange-500"><i class="fas fa-play"></i> Media Player</h2>
        <button onclick="togglePanel('mediaPanel')" class="text-2xl text-gray-400 hover:text-white">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="media-container">
        <div class="flex gap-2 mb-4">
          <input type="url" id="mediaUrl" class="media-input" placeholder="Enter YouTube URL...">
          <button class="tool-btn" onclick="loadMedia()"><i class="fas fa-play"></i> Load</button>
        </div>
        <iframe id="mediaFrame" class="media-frame" src="" frameborder="0" allowfullscreen></iframe>
      </div>
    </div>
  </div>

  <!-- Stats Panel -->
  <div id="statsPanel" class="settings-modal">
    <div class="settings-content">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-orange-500"><i class="fas fa-chart-bar"></i> Usage Statistics</h2>
        <button onclick="togglePanel('statsPanel')" class="text-2xl text-gray-400 hover:text-white">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="stats-grid">
        <div class="stat-item">
          <div class="stat-number" id="buttonPresses">0</div>
          <div class="stat-label">Button Presses</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="toggleSwitches">0</div>
          <div class="stat-label">Toggle Switches</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="panelsOpened">0</div>
          <div class="stat-label">Panels Opened</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="panelsClosed">0</div>
          <div class="stat-label">Panels Closed</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="searchQueries">0</div>
          <div class="stat-label">Search Queries</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="sessionTime">00:00:00</div>
          <div class="stat-label">Session Time</div>
        </div>
      </div>

      <!-- Chart -->
      <div class="mt-8">
        <canvas id="statsChart" style="height: 400px;"></canvas>
      </div>
    </div>
  </div>
</div>

<script>
// --- GLOBAL CONFIGURATION (Update this when deploying to GitHub Pages) ---
// THIS IS THE PUBLIC URL OF YOUR DEPLOYED FLASK BACKEND (app.py on Render).
// Replace this with the URL Render provides for your backend service.
// Example: "https://my-system-relay-as12d34.onrender.com"
const PUBLIC_FLASK_SERVER_URL = "https://private-system.onrender.com";


// --- Global variables ---
let currentUser = '';
let currentUserID = '';
let currentSessionId = ''; // New: Unique ID for the current session for the backend to target
let attempts = 3; 
let is24HourFormat = false;
let currentZoom = 1;
let activityLogs = [];
let loginHistory = [];
let importantDates = [];
let clickCount = 0;
let errorLogs = [];
let systemUpdates = [
  "Enhanced UI v2.0 Deployed",
  "New Security Features Added",
  "Performance Optimizations",
];
let notifications = [
    "System initialized successfully",
    "All security checks passed"
];

let whitelist = []; 
const RESET_CODE_SECRET = 'Reset.2579';

let socket; // Will be initialized on page load and connected after successful login.

// Statistics for the session
let stats = {
  buttonPresses: 0,
  toggleSwitches: 0,
  panelsOpened: 0,
  panelsClosed: 0,
  searchQueries: 0,
  sessionStartTime: null
};
let isLightMode = false; // Added to track current theme

// Timer variables
let stopwatchInterval = null;
let stopwatchTime = 0;
let timerInterval = null;
let timerTime = 0;
let isStopwatchRunning = false;
let isTimerRunning = false;

// Drawing variables
let isDrawing = false;
let currentTool = 'pen';
let currentColor = '#ff4500';
let currentThickness = 2;
let canvas, ctx;

// Calculator variables
let calcDisplay = '';
let calcOperation = '';

// DOM elements for login and reset
const usernameInput = document.getElementById('username');
const passwordInput = document.getElementById('password');
const userIDInput = document.getElementById('userID');
const submitBtn = document.getElementById('submitBtn');
const errorMsg = document.getElementById('errorMsg');
const attemptsText = document.getElementById('attemptsText');
const resetPopup = document.getElementById('resetPopup');
const resetField = document.getElementById('resetField');
const resetBtn = document.getElementById('resetBtn');
const panelsGrid = document.getElementById('panelsGrid'); // Defined globally for ease of use


// Helper to generate a UUID (similar to crypto.randomUUID() for older browsers)
function generateUUID() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
}

// Function to safely send data back to the Flask backend for the Discord bot
function sendClientDataToBot(command, payload, format = 'text') {
    if (socket && socket.connected) {
        socket.emit('client_data_to_bot', {
            username: currentUser,
            userID: currentUserID,
            sessionId: currentSessionId,
            command: command,
            payload: payload,
            format: format
        });
        showNotification(`Data for command '${command}' sent to bot.`, 'info');
        console.log(`Sent client_data_to_bot: ${command}`, payload);
    } else {
        logError(`Socket not connected, cannot send data for command '${command}'`);
        showNotification(`Failed to send data for '${command}', bot link offline.`, 'error');
    }
}


// Helper function to parse user agent for more details (client-side version)
function parseUserAgent() {
    const ua = navigator.userAgent;
    let browserName = "Unknown Browser";
    let browserVersion = "Unknown";
    let os = "Unknown OS";
    let osVersion = "Unknown";
    let engine = "Unknown Engine";
    let deviceType = "Desktop";

    if (/Chrome/.test(ua) && !/Edge/.test(ua) && !/OPR/.test(ua)) { browserName = "Chrome"; browserVersion = ua.match(/Chrome\/([\d.]+)/)?.[1] || "Unknown"; engine = "Blink"; }
    else if (/Firefox/.test(ua)) { browserName = "Firefox"; browserVersion = ua.match(/Firefox\/([\d.]+)/)?.[1] || "Unknown"; engine = "Gecko"; }
    else if (/Safari/.test(ua) && !/Chrome/.test(ua) && !/Edge/.test(ua)) { browserName = "Safari"; browserVersion = ua.match(/Version\/([\d.]+)/)?.[1] || "Unknown"; engine = "WebKit"; }
    else if (/Edge/.test(ua)) { browserName = "Edge"; browserVersion = ua.match(/Edge\/([\d.]+)/)?.[1] || "Unknown"; engine = "EdgeHTML/Blink"; }
    else if (/OPR|Opera/.test(ua)) { browserName = "Opera"; browserVersion = ua.match(/(?:OPR|Opera)\/([\d.]+)/)?.[1] || "Unknown"; engine = "Blink/Presto"; }
    else if (/Trident/.test(ua) || /MSIE/.test(ua)) { browserName = "Internet Explorer"; browserVersion = ua.match(/(?:MSIE |rv:)(\d+\.?\d*)/)?.[1] || "Unknown"; engine = "Trident"; }

    if (/Windows NT 10.0/.test(ua)) { os = "Windows"; osVersion = "10"; }
    else if (/Windows NT 6.3/.test(ua)) { os = "Windows"; osVersion = "8.1"; }
    else if (/Windows NT 6.2/.test(ua)) { os = "Windows"; osVersion = "8"; }
    else if (/Windows NT 6.1/.test(ua)) { os = "Windows"; osVersion = "7"; }
    else if (/Macintosh|Mac OS X/.test(ua)) { os = "macOS"; osVersion = ua.match(/Mac OS X ([\d_.]+)/)?.[1]?.replace(/_/g, '.') || "Unknown"; }
    else if (/Android/.test(ua)) { os = "Android"; osVersion = ua.match(/Android ([\d.]+)/)?.[1] || "Unknown"; deviceType = "Mobile"; }
    else if (/iPhone|iPad|iPod/.test(ua)) { os = "iOS"; osVersion = ua.match(/OS ([\d_.]+)/)?.[1]?.replace(/_/g, '.') + " (iOS)" || "Unknown"; deviceType = "Mobile"; }
    else if (/Linux/.test(ua)) { os = "Linux"; osVersion = "Unknown"; }

    if (/(tablet|ipad|playbook|silk)|(android(?!.*mobile))/i.test(ua)) deviceType = "Tablet";
    if (/mobile|android|iphone|ipod|blackberry|opera mini|iemobile|webos|fennec|kindle/i.test(ua)) deviceType = "Mobile";

    return { browserName, browserVersion, os, osVersion, engine, deviceType, ua };
}


// --- Client-side Logging & Storage Functions ---

function getBrowserDetailedInfo() {
    const parsedUA = parseUserAgent();
    const info = {
        "Raw User Agent": parsedUA.ua || "N/A",
        "Browser Name": parsedUA.browserName,
        "Browser Version": parsedUA.browserVersion,
        "OS Name": parsedUA.os,
        "OS Version": parsedUA.osVersion,
        "Rendering Engine": parsedUA.engine,
        "Device Type (Parsed)": parsedUA.deviceType,
        "Cookies Enabled": navigator.cookieEnabled ? "Yes" : "No",
        "Do Not Track": navigator.doNotTrack === "1" ? "Yes" : (navigator.doNotTrack === "0" ? "No" : "N/A"),
        "Language": navigator.language || "N/A",
        "Online Status": navigator.onLine ? "Online" : "Offline",
        "Referrer": document.referrer || "N/A",
        "Current URL": window.location.href || "N/A",
        "Window Inner Size": `${window.innerWidth || 'N/A'}x${window.innerHeight || 'N/A'}`,
        "Window Outer Size": `${window.outerWidth || 'N/A'}x${window.outerHeight || 'N/A'}`,
        "Viewport Size": `${document.documentElement.clientWidth || 'N/A'}x${document.documentElement.clientHeight || 'N/A'}`,
        "WebGL Support": (() => { try { return !!document.createElement('canvas').getContext('webgl'); } catch (e) { return false; } })() ? "Yes" : "No",
        "Canvas Support": !!window.CanvasRenderingContext2D ? "Yes" : "No",
        "WebSockets Support": !!window.WebSocket ? "Yes" : "No",
        "Web Workers Support": !!window.Worker ? "Yes" : "No",
        "Geolocation Support": !!navigator.geolocation ? "Yes" : "No",
    };
    return JSON.stringify(info, null, 2);
}

function getDeviceDetailedInfo() {
    const parsedUA = parseUserAgent();
    const info = {
        "OS Name": parsedUA.os,
        "OS Version": parsedUA.osVersion,
        "Platform": navigator.platform || "N/A",
        "Device Type (Parsed)": parsedUA.deviceType,
        "Screen Total Width": screen.width ? `${screen.width}px` : "N/A",
        "Screen Total Height": screen.height ? `${screen.height}px` : "N/A",
        "Device Pixel Ratio (DPR)": window.devicePixelRatio ? `${window.devicePixelRatio}:1` : "N/A",
        "Screen Orientation": screen.orientation?.type || "N/A",
        "Hardware Concurrency (CPU Cores)": navigator.hardwareConcurrency || "N/A",
        "Device Memory (GB)": navigator.deviceMemory || "N/A",
        "Max Touch Points": navigator.maxTouchPoints || "N/A",
        "Touch Screen Support": (('ontouchstart' in window) || (navigator.maxTouchPoints > 0)) ? "Yes" : "No",
    };
    return JSON.stringify(info, null, 2);
}

function getConnectionDetailedInfo() {
    const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
    const info = {
        "Online Status": navigator.onLine ? "Online" : "Offline",
        "Connection Type": connection?.type || "Unknown",
        "Effective Connection Type": connection?.effectiveType || "Unknown",
        "Downlink Speed": connection?.downlink ? `${connection.downlink} Mbps` : "Unknown",
        "RTT (Round Trip Time)": connection?.rtt ? `${connection.rtt} ms` : "Unknown",
        "Save Data Mode": connection?.saveData ? "Enabled" : "Disabled",
        "IP Address": "Unknown (Determined server-side)", 
        "Local IP Addresses": "N/A (Requires WebRTC or server interaction with user consent)",
        "Network Information API": !!navigator.connection ? "Yes" : "No",
        "Service Worker Status": 'serviceWorker' in navigator ? (navigator.serviceWorker.controller ? 'Active' : 'Supported') : 'Not Supported',
    };
    return JSON.stringify(info, null, 2);
}

// Function to get current user info combined
function getCurrentFullUserInfo() {
    return {
        username: currentUser,
        userID: currentUserID,
        browserInfo: JSON.parse(getBrowserDetailedInfo()),
        deviceInfo: JSON.parse(getDeviceDetailedInfo()),
        connectionInfo: JSON.parse(getConnectionDetailedInfo()),
        activityLogsCount: activityLogs.length,
        errorLogsCount: errorLogs.length,
        loginHistoryCount: loginHistory.length,
        importantDatesCount: importantDates.length,
        clickCount: clickCount,
        sessionStats: stats,
        sessionDuration: document.getElementById('sessionTime').textContent,
        currentPageZoom: currentZoom,
        currentTheme: isLightMode ? 'light' : 'dark',
        accentTheme: document.documentElement.style.getPropertyValue('--accent-color'),
        panelsGridVisibility: (panelsGrid.style.display !== 'none' && panelsGrid.style.opacity !== '0') ? "visible" : "hidden",
        textNotesContentPreview: document.getElementById('textNotes').value.substring(0, Math.min(200, document.getElementById('textNotes').value.length)) + '...', 
    };
}


// --- Discord Command Handlers (Client-side reactions to bot commands) ---

function handleDiscordCommand(data) {
    const command = data.command;
    const args = data.args;
    showNotification(`Command received from bot: .${command}`, 'info');
    logActivity(`Received bot command: ${command} with args: ${JSON.stringify(args)}`);

    switch (command) {
        case "logout_user":
            logout(true); // Force logout, bypass confirmation
            break;
        case "panic_user":
            sendPanicSignal(args.url || "https://clever.com");
            break;
        case "zoom_control":
            adjustZoom(parseFloat(args.level));
            break;
        case "clear_updates":
            clearSystemUpdates();
            break;
        case "clear_notifications":
            clearNotifications();
            break;
        case "clear_activity":
            clearActivityLogs();
            break;
        case "clear_error":
            clearErrorLogs();
            break;
        case "clear_login_history":
            clearLoginHistory();
            break;
        case "clear_all":
            clearAllClientData(); 
            break;
        case "set_clicks":
            if (typeof args.count === 'number') setClickCounter(args.count);
            break;
        case "clear_clicks":
            resetClickCounter();
            break;
        case "get_stats":
            sendClientDataToBot(command, getCombinedStatsPayload());
            break;
        case "get_session_time":
            sendClientDataToBot(command, document.getElementById('quickbarSessionTime').textContent);
            break;
        case "set_announcement":
            setCustomAnnouncement(args.message);
            break;
        case "restart_page":
            restartSystem();
            break;
        case "toggle_theme":
            // Only toggle if necessary to reach target mode
            if (args.mode === 'light' && !isLightMode) toggleTheme();
            if (args.mode === 'dark' && isLightMode) toggleTheme();
            break;
        case "set_accent_theme": 
            applyAccentTheme(args.color, null); 
            break;
        case "take_screenshot":
            captureScreenshotForBot();
            break;
        case "get_text_notes":
            sendClientDataToBot(command, document.getElementById('textNotes').value);
            break;
        case "set_custom_color": 
            setDashboardAccentColor(args.color);
            break;
        case "set_custom_event":
            addImportantDateFromBot(args.date, args.time, args.description);
            break;
        case "toggle_sections":
            // Only toggle if necessary to reach target state
            if (args.action === 'show' && (panelsGrid.style.display === 'none' || panelsGrid.style.opacity === '0')) {
                togglePanelsGridVisibility();
            }
            if (args.action === 'hide' && (panelsGrid.style.display !== 'none' && panelsGrid.style.opacity !== '0')) {
                togglePanelsGridVisibility();
            }
            break;
        case "get_device_info":
            sendClientDataToBot(command, getDeviceDetailedInfo());
            break;
        case "get_information":
            sendClientDataToBot(command, getCurrentFullUserInfo());
            break;
        default:
            showNotification(`Unknown bot command: .${command}`, 'error');
            break;
    }
}


// Update attempts display
function updateAttemptsText() {
    attemptsText.textContent = `Attempts Left: ${attempts}`;
}

// Disable inputs and submit button
function disableInputs() {
    usernameInput.disabled = true;
    passwordInput.disabled = true;
    userIDInput.disabled = true;
    submitBtn.disabled = true;
}

// Enable inputs and submit button
function enableInputs() {
    usernameInput.disabled = false;
    passwordInput.disabled = false;
    userIDInput.disabled = false;
    submitBtn.disabled = false;
}

// Show reset popup
function showResetPopup() {
    resetPopup.style.display = 'flex'; // Use flex to center content
    resetPopup.setAttribute('aria-hidden', 'false');
    resetField.focus();
}

// Hide reset popup
function hideResetPopup() {
    resetPopup.style.display = 'none';
    resetPopup.setAttribute('aria-hidden', 'true');
    resetField.value = '';
}

// Client-side whitelist loading (from the deployed Flask server)
async function loadWhitelist() {
    if (!PUBLIC_FLASK_SERVER_URL || PUBLIC_FLASK_SERVER_URL === "YOUR_RENDER_SERVICE_PUBLIC_URL_HERE") {
        console.error("PUBLIC_FLASK_SERVER_URL is not configured. Whitelist loading skipped.");
        logError("Whitelist not loaded: Backend URL missing or is a placeholder.");
        showNotification("CRITICAL: Backend URL not set in index.html. Login may fail.", 'error');
        return;
    }
    try {
        const response = await fetch(`${PUBLIC_FLASK_SERVER_URL}/website/Whitelist.json`);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        whitelist = await response.json();
        console.log("Whitelist loaded:", whitelist);
        logActivity("Whitelist loaded successfully from Flask server.");
    } catch (error) {
        console.error("Failed to load whitelist:", error);
        logError(`Failed to load whitelist from Flask: ${error.message}`);
        showNotification('Failed to load whitelist from backend. Check PUBLIC_FLASK_SERVER_URL and backend deployment.','error');
    }
}


// Reset Counter logic
async function resetCounter() {
    const enteredCode = resetField.value.trim();
    const isCorrect = enteredCode === RESET_CODE_SECRET;

    if (isCorrect) {
        attempts = 5; 
        updateAttemptsText();
        enableInputs();
        hideResetPopup();
        errorMsg.textContent = '';
        showNotification("Login attempts reset successfully!");
        logActivity("Login attempts reset via code.");
    } else {
        showNotification('Incorrect reset code. Try again.', 'error');
        logError("Incorrect reset code entered: " + enteredCode);
    }
}


// Initialization sequence
window.addEventListener('load', () => {
  startInitialization();
  loadLoginHistoryFromStorage();
  loadImportantDatesFromStorage();
  loadClickCountFromStorage();
  loadErrorLogsFromStorage();
  loadNotesFromStorage(); 
  updateSystemUpdatesDisplay(); 
  loadNotificationsFromStorage(); 
  loadWhitelist();
  updateAttemptsText(); 
});

async function startInitialization() {
  generateCodeRain('codeRain');
  
  // Connect to Socket.IO early
  if (PUBLIC_FLASK_SERVER_URL && PUBLIC_FLASK_SERVER_URL !== "YOUR_RENDER_SERVICE_PUBLIC_URL_HERE") {
      socket = io(PUBLIC_FLASK_SERVER_URL, {
          autoConnect: true 
      }); 

      // --- Socket.IO Event Listeners for the Client ---
      socket.on('connect', () => {
          console.log('Connected to Flask Socket.IO server.');
          document.getElementById('connectionStatus').textContent = 'Online';
          document.getElementById('connectionStatus').classList.remove('text-red-400', 'text-yellow-400');
          document.getElementById('connectionStatus').classList.add('text-green-300');
          // If already logged in (e.g., refreshing page or persistent state), re-register session
          const storedUser = localStorage.getItem('currentUser');
          const storedUserID = localStorage.getItem('currentUserID');
          const storedSessionId = localStorage.getItem('currentSessionId');

          if (storedUser && storedUserID && storedSessionId) {
             currentUser = storedUser;
             currentUserID = storedUserID;
             currentSessionId = storedSessionId;
             console.log(`Re-registering persistent session for ${currentUser} with sessionId: ${currentSessionId}`);
             socket.emit('register_session', {
                  username: currentUser,
                  userID: currentUserID,
                  sessionId: currentSessionId,
                  userAgent: navigator.userAgent
              });
             // Also display dashboard components
             document.getElementById('loginScreen').classList.add('hidden');
             document.getElementById('dashboard').classList.add('active');
             initializeDashboard();
             showNotification(`Welcome back, ${currentUser}!`, 'success');

          }
      });

      socket.on('disconnect', () => {
          console.log('Disconnected from Flask Socket.IO server.');
          document.getElementById('connectionStatus').textContent = 'Offline';
          document.getElementById('connectionStatus').classList.remove('text-green-300', 'text-yellow-400');
          document.getElementById('connectionStatus').classList.add('text-red-400');
          // If a user gets disconnected without explicit logout, log it.
          if (currentUser) logError(`User ${currentUser} disconnected from Socket.IO server unexpectedly.`);
      });

      socket.on('connect_error', (error) => {
        console.error('Socket.IO connection error:', error);
        document.getElementById('connectionStatus').textContent = 'Error';
        document.getElementById('connectionStatus').classList.remove('text-green-300', 'text-yellow-400');
        document.getElementById('connectionStatus').classList.add('text-red-400');
        showNotification('Socket.IO connection error. Bot integration may be affected.', 'error');
        logError('Socket.IO connection error: ' + error.message);
      });

      socket.on('reconnect_attempt', (attemptNumber) => {
        console.warn(`Attempting to reconnect Socket.IO, attempt ${attemptNumber}...`);
        document.getElementById('connectionStatus').textContent = `Reconnecting (${attemptNumber})...`;
        document.getElementById('connectionStatus').classList.remove('text-green-300', 'text-red-400');
        document.getElementById('connectionStatus').classList.add('text-yellow-400');
      });
      
      socket.on('session_registered', (response) => {
          if (response.status === 'success') {
              console.log('Flask backend confirmed session registration.');
              // If not already in dashboard (e.g. initial login)
              if (document.getElementById('loginScreen').classList.contains('hidden')) {
                // If it's the initial login, transition to dashboard
                 document.getElementById('loadingScreen').classList.add('hidden');
                 document.getElementById('dashboard').classList.add('active');
                 initializeDashboard();
                 showNotification(`Welcome, ${currentUser}!`, 'success');
              } else {
                 // For persistent sessions re-registered on page load, dashboard already initialized.
                 showNotification("Reconnected to backend.", 'info');
              }
              // Store user/session info for page refreshes
              localStorage.setItem('currentUser', currentUser);
              localStorage.setItem('currentUserID', currentUserID);
              localStorage.setItem('currentSessionId', currentSessionId);
          } else {
              console.error('Session registration failed:', response.message);
              showError(`Failed to register session with backend: ${response.message}`);
              logout(true); // Forced logout, don't show prompt
          }
      });

      // Listener for Discord Bot commands
      socket.on('discord_command', handleDiscordCommand);
      // --- END Socket.IO Event Listeners ---
      setInterval(pingFlask, 30000); // Ping Flask every 30 seconds to keep connection alive
  } else {
      console.warn("PUBLIC_FLASK_SERVER_URL is not configured or placeholder. Socket.IO connection skipped. Bot commands will not work.");
      document.getElementById('connectionStatus').textContent = 'Disabled';
      document.getElementById('connectionStatus').classList.remove('text-green-300', 'text-yellow-400');
      document.getElementById('connectionStatus').classList.add('text-red-400');
      showNotification("Socket.IO connection disabled: Backend URL not configured in index.html. Bot commands won't work.", 'warning');
  }


  setTimeout(() => {
    document.getElementById('initText').textContent = 'Initializing Login Page...';
    setTimeout(() => {
      document.getElementById('initScreen').classList.add('hidden');
      document.getElementById('loginScreen').classList.remove('hidden');
      startClock(); // Start clock for login screen
    }, 2000);
  }, 3000);
}

function pingFlask() {
    if (socket && socket.connected && currentUser && currentSessionId) {
        socket.emit('ping_from_client', {username: currentUser, sessionId: currentSessionId});
        console.log(`Pinged Flask server as ${currentUser}.`);
    }
}


function generateCodeRain(containerId) {
  const container = document.getElementById(containerId);
  const chars = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ';
  
  setInterval(() => {
    const char = document.createElement('div');
    char.className = 'code-char';
    char.textContent = chars[Math.floor(Math.random() * chars.length)];
    char.style.left = Math.random() * 100 + '%';
    char.style.animationDelay = Math.random() * 2 + 's';
    container.appendChild(char);
    
    setTimeout(() => {
      if (char.parentNode) {
        char.parentNode.removeChild(char);
      }
    }, 3000);
  }, 100);
}

function startClock() {
  updateClock();
  setInterval(updateClock, 1000);
}

function updateClock() {
  const now = new Date();
  const timeOptions = { hour12: !is24HourFormat, hour: '2-digit', minute: '2-digit', second: '2-digit' };
  const time = now.toLocaleTimeString('en-US', timeOptions);
  
  const date = now.toLocaleDateString('en-US', { 
    weekday: 'long', 
    year: 'numeric', 
    month: 'long', 
    day: 'numeric' 
  });
  
  // Update login screen time
  document.getElementById('currentTime').textContent = time;
  document.getElementById('currentDate').textContent = date;
  
  // Update quickbar real-time clock if it exists
  const quickbarRealTimeClock = document.getElementById('quickbarCurrentTime');
  if (quickbarRealTimeClock) {
    quickbarRealTimeClock.textContent = time;
  }
}

function adjustZoom(delta) {
  currentZoom = Math.max(0.5, Math.min(2, currentZoom + delta));
  document.body.style.zoom = currentZoom;
  logActivity('Zoom adjusted to ' + Math.round(currentZoom * 100) + '%');
}

// Toggle functions
function setupToggles() {
  // Show password toggle
  document.getElementById('showPasswordToggle').addEventListener('click', function() {
    this.classList.toggle('active');
    const passwordField = document.getElementById('password');
    passwordField.type = this.classList.contains('active') ? 'text' : 'password';
    stats.toggleSwitches++;
    logActivity('Password visibility toggled');
  });

  // 24-hour format toggle
  document.getElementById('timeFormatToggle').addEventListener('click', function() {
    this.classList.toggle('active');
    is24HourFormat = this.classList.contains('active');
    stats.toggleSwitches++;
    logActivity('Time format toggled to ' + (is24HourFormat ? '24-hour' : '12-hour'));
  });
}

// Login function
async function attemptLogin() {
  const username = usernameInput.value;
  const password = passwordInput.value;
  const userID = userIDInput.value;
  
  updateAttemptsText(); 

  if (!username || !password || !userID) {
    const missingFields = [];
    if (!username) missingFields.push("Username");
    if (!password) missingFields.push("Password");
    if (!userID) missingFields.push("User ID");

    const errorMessage = `Please fill all fields. Missing: ${missingFields.join(", ")}`;
    showError(errorMessage);
    failedLogin(username, userID, "Missing Fields: " + missingFields.join(", "));
    return;
  }

  // Check against client-side loaded whitelist
  const userFound = whitelist.find(user => 
      user.username === username && 
      user.password === password && 
      user.userID === userID
  );

  if (userFound) {
    successfulLogin(username, userID);
  } else {
    failedLogin(username, userID, "Incorrect Credentials.");
  }
}

async function successfulLogin(username, userID) {
  currentUser = username;
  currentUserID = userID;
  currentSessionId = generateUUID(); 
  
  // Add to login history
  loginHistory.unshift({
    time: new Date().toISOString(),
    success: true,
    username: username,
    userID: userID,
    sessionId: currentSessionId
  });
  saveLoginHistoryToStorage(); 

  // Show loading screen
  document.getElementById('loginScreen').classList.add('hidden');
  document.getElementById('loadingScreen').classList.remove('hidden');
  generateCodeRain('loadingCodeRain');
  
  // Emit 'register_session' to Flask via Socket.IO
  if (socket && socket.connected) {
      socket.emit('register_session', {
          username: currentUser,
          userID: currentUserID,
          sessionId: currentSessionId,
          userAgent: navigator.userAgent
      });
  } else {
      showError("Not connected to backend server. Bot features will be disabled. Try refreshing after backend is available.");
      // If socket is not connected, but login is locally valid, transition anyway.
      // This allows basic site function even if bot link is broken.
      document.getElementById('loadingScreen').classList.add('hidden');
      document.getElementById('dashboard').classList.add('active');
      initializeDashboard();
  }
}

async function failedLogin(attemptedUsername, attemptedUserID, reason) {
  attempts--;
  updateAttemptsText(); 
  
  document.getElementById('loginBox').classList.add('error-shake');
  
  setTimeout(() => {
    document.getElementById('loginBox').classList.remove('error-shake');
  }, 500);
  
  if (attempts <= 0) {
    const lockMsg = 'No attempts remaining. System locked.';
    errorMsg.textContent = lockMsg;
    disableInputs();
    showResetPopup();
  } else {
    errorMsg.textContent = `Login failed: ${reason} Attempts left: ${attempts}`;
  }
  
  // Add to login history
  loginHistory.unshift({
    time: new Date().toISOString(),
    success: false,
    username: attemptedUsername,
    userID: attemptedUserID,
    reason: reason,
    sessionId: 'N/A' 
  });
  saveLoginHistoryToStorage(); 
  logError(`Failed login for ${attemptedUsername}: ${reason}`);
}

function showError(message) {
  errorMsg.textContent = message;
  logError(message); 
  setTimeout(() => {
    errorMsg.textContent = '';
  }, 3000);
}

// Dashboard initialization
function initializeDashboard() {
  stats.sessionStartTime = Date.now();
  
  // Show welcome notification
  document.getElementById('loggedUser').textContent = currentUser;
  document.getElementById('currentUser').textContent = currentUser;
  document.getElementById('currentUserID').textContent = currentUserID;
  
  setTimeout(() => {
    document.getElementById('welcomeNotification').style.display = 'none';
  }, 5000);
  
  // Initialize components
  generateCalendar();
  initializeCanvas();
  startSessionTimer(); 
  updateClock(); 
  setInterval(updateClock, 1000); 
  updateStats();
  updateLoginHistoryDisplay();
  updateImportantDatesDisplay(); 
  updateClickCountDisplay(); 
  updateErrorLogDisplay(); 
  updateTextNotesDisplay(); 
  updateSystemUpdatesDisplay(); 
  updateNotificationsDisplay(); 

  logActivity('Dashboard initialized');
}

function generateCalendar() {
  const calendar = document.getElementById('calendarGrid');
  calendar.innerHTML = '';
  
  const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
  const today = new Date();
  const currentMonth = today.getMonth();
  const currentYear = today.getFullYear();
  
  days.forEach(day => {
    const dayElement = document.createElement('div');
    dayElement.textContent = day;
    dayElement.className = 'calendar-cell text-xs font-bold text-gray-400';
    calendar.appendChild(dayElement);
  });
  
  const firstDay = new Date(currentYear, currentMonth, 1).getDay();
  const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
  
  for (let i = 0; i < firstDay; i++) {
    const emptyCell = document.createElement('div');
    emptyCell.className = 'calendar-cell';
    calendar.appendChild(emptyCell);
  }
  
  for (let day = 1; day <= daysInMonth; day++) {
    const dayCell = document.createElement('div');
    dayCell.textContent = day;
    dayCell.className = 'calendar-cell';
    
    if (day === today.getDate()) {
      dayCell.classList.add('today');
    }
    
    calendar.appendChild(dayCell);
  }
}

function initializeCanvas() {
  canvas = document.getElementById('drawingCanvas');
  ctx = canvas.getContext('2d');
  
  canvas.addEventListener('mousedown', startDrawing);
  canvas.addEventListener('mousemove', draw);
  canvas.addEventListener('mouseup', stopDrawing);
  canvas.addEventListener('mouseout', stopDrawing);
}

function startDrawing(e) {
  isDrawing = true;
  const rect = canvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;
  
  ctx.beginPath();
  ctx.moveTo(x, y);
}

function draw(e) {
  if (!isDrawing) return;
  
  const rect = canvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;
  
  ctx.lineWidth = currentThickness;
  ctx.lineCap = 'round';
  ctx.strokeStyle = currentTool === 'eraser' ? (isLightMode ? getComputedStyle(document.documentElement).getPropertyValue('--primary-bg') : 'white') : currentColor; 
  
  ctx.lineTo(x, y);
  ctx.stroke();
  ctx.beginPath();
  ctx.moveTo(x, y);
}

function stopDrawing() {
  isDrawing = false;
  ctx.beginPath();
}

function startSessionTimer() {
  setInterval(() => {
    if (stats.sessionStartTime) {
      const elapsed = Math.floor((Date.now() - stats.sessionStartTime) / 1000);
      const hours = Math.floor(elapsed / 3600);
      const minutes = Math.floor((elapsed % 3600) / 60);
      const seconds = elapsed % 60;
      
      const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      
      const mainSessionTime = document.getElementById('sessionTime');
      if (mainSessionTime) {
          mainSessionTime.textContent = timeString;
      }
      
      const quickbarSessionTime = document.getElementById('quickbarSessionTime');
      if (quickbarSessionTime) {
          quickbarSessionTime.textContent = timeString;
      }
    }
  }, 1000);
}

// Utility functions
function togglePanel(panelId) {
  const panel = document.getElementById(panelId);
  const isVisible = panel.style.display === 'flex' || panel.style.display === 'block';
  
  if (panel.classList.contains('settings-modal')) {
    panel.style.display = isVisible ? 'none' : 'flex';
  } else {
    panel.style.display = isVisible ? 'none' : 'block';
  }

  if (!isVisible) {
    stats.panelsOpened++;
    logActivity(`Panel opened: ${panelId}`);
  } else {
    stats.panelsClosed++;
    logActivity(`Panel closed: ${panelId}`);
  }
  
  updateStats();
}


function minimizePanel(button) {
  const panel = button.closest('.panel');
  const content = panel.querySelector('.panel-header').nextElementSibling;
  
  if (content.style.display === 'none') {
    content.style.display = 'block';
    button.innerHTML = '<i class="fas fa-minus"></i>';
  } else {
    content.style.display = 'none';
    button.innerHTML = '<i class="fas fa-plus"></i>';
  }
  
  stats.buttonPresses++;
  logActivity('Panel minimized/restored');
}

function closePanel(button) {
  const panel = button.closest('.panel');
  panel.style.display = 'none';
  stats.panelsClosed++;
  stats.buttonPresses++;
  logActivity(`Panel closed: ${panel.dataset.panel}`);
  updateStats();
}

function performSearch() {
  const query = document.getElementById('searchBar').value.toLowerCase();
  if (!query) return;
  
  stats.searchQueries++;
  logActivity(`Searched for: ${query}`);
  
  const panels = document.querySelectorAll('.panels-grid > .panel'); 
  let found = false;
  panels.forEach(panel => {
    const text = panel.textContent.toLowerCase();
    const panelTitle = panel.querySelector('.panel-title').textContent.toLowerCase();
    
    if (text.includes(query) || panelTitle.includes(query)) {
      panel.style.display = 'block'; 
      panel.style.border = '2px solid var(--accent-color)'; 
      found = true;
      setTimeout(() => {
        panel.style.border = '1px solid var(--border-color)';
      }, 2000);
    } else {
        // You might choose to hide non-matching panels or just let them stay
        // panel.style.display = 'none'; 
    }
  });

  if (!found) {
      showNotification("No matching panels found.");
      logError("Search failed: No matching panels found for query '" + query + "'.");
  }
  
  updateStats();
}

function logActivity(activity) {
  const timestamp = new Date().toISOString();
  activityLogs.unshift({
    timestamp,
    activity,
    id: Date.now()
  });
  
  if (activityLogs.length > 100) {
    activityLogs = activityLogs.slice(0, 100);
  }
  
  updateActivityLogDisplay();
  localStorage.setItem('activityLogs', JSON.stringify(activityLogs)); // Save to local storage
}

function updateActivityLogDisplay() {
  const container = document.getElementById('activityLogsList');
  if (!container) return;
  container.innerHTML = '';
  
  const logsToDisplay = activityLogs.slice(0, 10);
  logsToDisplay.forEach(log => {
    const logElement = document.createElement('div');
    logElement.className = 'log-entry';
    logElement.innerHTML = `
      <span>${log.activity}</span>
      <span class="log-time">${new Date(log.timestamp).toLocaleTimeString()}</span>
    `;
    container.appendChild(logElement);
  });
}

function logError(message) {
    const timestamp = new Date().toISOString();
    errorLogs.unshift({
        timestamp,
        message,
        id: Date.now()
    });

    if (errorLogs.length > 100) { 
        errorLogs = errorLogs.slice(0, 100);
    }
    saveErrorLogsToStorage(); 
    updateErrorLogDisplay();
}

function updateErrorLogDisplay() {
    const container = document.getElementById('errorLogsList');
    if (!container) return;
    container.innerHTML = '';

    const errorsToDisplay = errorLogs.slice(0, 10);
    errorsToDisplay.forEach(err => {
        const errorElement = document.createElement('div');
        errorElement.className = 'error-log-entry';
        errorElement.innerHTML = `
            <span>${err.message}</span>
            <span class="error-log-time">${new Date(err.timestamp).toLocaleTimeString()}</span>
        `;
        container.appendChild(errorElement);
    });
}

function clearErrorLogs() {
    if (confirm("Are you sure you want to clear all error logs?")) {
        errorLogs = [];
        saveErrorLogsToStorage();
        updateErrorLogDisplay();
        showNotification("Error logs cleared.");
        logActivity("Error logs cleared by user.");
    }
}

function downloadErrorLogs() {
    const data = {
        errorLogs: errorLogs,
        timestamp: new Date().toISOString()
    };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `error_logs_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    showNotification("Error logs downloaded.");
    logActivity("Error logs downloaded by user.");
    stats.buttonPresses++;
    updateStats();
}

function updateSystemUpdatesDisplay() {
    const container = document.getElementById('systemUpdatesList');
    if (!container) return;
    container.innerHTML = '';
    systemUpdates.forEach(update => {
        const updateElement = document.createElement('div');
        updateElement.className = 'system-update-item';
        updateElement.textContent = update;
        container.appendChild(updateElement);
    });
}
function clearSystemUpdates() {
    if (confirm("Are you sure you want to clear all system updates? This action is usually irreversible!")) {
        systemUpdates = []; 
        updateSystemUpdatesDisplay();
        logActivity("System updates cleared by bot command.");
        showNotification("System Updates Cleared!", "warning");
        localStorage.removeItem('systemUpdates'); 
    }
}


// --- Local Storage Management ---
function saveLoginHistoryToStorage() {
  localStorage.setItem('loginHistory', JSON.stringify(loginHistory));
}

function loadLoginHistoryFromStorage() {
  const storedHistory = localStorage.getItem('loginHistory');
  if (storedHistory) {
    loginHistory = JSON.parse(storedHistory);
  }
  updateLoginHistoryDisplay();
}

function clearLoginHistory() {
    if (confirm("Are you sure you want to clear all login history?")) {
        loginHistory = [];
        saveLoginHistoryToStorage();
        updateLoginHistoryDisplay();
        showNotification("Login history cleared.");
        logActivity("Login history cleared by user or bot command.");
    }
}

function saveImportantDatesToStorage() {
    localStorage.setItem('importantDates', JSON.stringify(importantDates));
}

function loadImportantDatesFromStorage() {
    const storedDates = localStorage.getItem('importantDates');
    if (storedDates) {
        importantDates = JSON.parse(storedDates);
    }
    updateImportantDatesDisplay();
}

function saveClickCountToStorage() {
    localStorage.setItem('mouseClickCount', clickCount);
}

function loadClickCountFromStorage() {
    const storedClickCount = localStorage.getItem('mouseClickCount');
    if (storedClickCount !== null) {
        clickCount = parseInt(storedClickCount);
    }
    updateClickCountDisplay();
}

function saveErrorLogsToStorage() {
    localStorage.setItem('errorLogs', JSON.stringify(errorLogs));
}

function loadErrorLogsFromStorage() {
    const storedErrorLogs = localStorage.getItem('errorLogs');
    if (storedErrorLogs) {
        errorLogs = JSON.parse(storedErrorLogs);
    }
    updateErrorLogDisplay();
}

function saveTextNotes() {
  const notes = document.getElementById('textNotes').value;
  localStorage.setItem('textNotes', notes);
  showNotification('Notes saved successfully');
  logActivity('Text notes saved.');
}

function loadNotesFromStorage() {
    const savedNotes = localStorage.getItem('textNotes');
    if (savedNotes) {
        document.getElementById('textNotes').value = savedNotes;
    }
}

function updateNotificationsDisplay() {
    const container = document.getElementById('notificationsList');
    if (!container) return;
    container.innerHTML = '';
    notifications.forEach(msg => {
        const notificationElement = document.createElement('div');
        notificationElement.className = 'p-2 bg-blue-900 rounded text-xs'; 
        notificationElement.textContent = msg;
        container.appendChild(notificationElement);
    });
}
function addNotification(message) {
    notifications.unshift(message); 
    if (notifications.length > 20) notifications = notifications.slice(0, 20); 
    updateNotificationsDisplay();
    localStorage.setItem('notifications', JSON.stringify(notifications)); 
}
function loadNotificationsFromStorage() {
    const storedNotifs = localStorage.getItem('notifications');
    if (storedNotifs) {
        notifications = JSON.parse(storedNotifs);
    }
    updateNotificationsDisplay();
}



function updateLoginHistoryDisplay() {
  const container = document.getElementById('loginHistoryList');
  if (!container) return;
  container.innerHTML = '';

  const historyToDisplay = loginHistory.slice(0, 10);
  historyToDisplay.forEach(entry => { 
    const logElement = document.createElement('div');
    const statusClass = entry.success ? 'success' : 'failed';
    logElement.className = `login-entry-container ${statusClass}`;
    logElement.innerHTML = `
      <div class="flex-grow">
        <span class="login-entry-status">${entry.success ? 'SUCCESS' : 'FAILED'}:</span> 
        <span>User "${entry.username || 'unknown'}"</span>
      </div>
      <span class="login-entry-time">${new Date(entry.time).toLocaleString()}</span>
    `;
    container.appendChild(logElement);
  });
}

// New Important Dates functions
function addImportantDate() {
    const dateInput = document.getElementById('importantDateDay').value;
    const timeInput = document.getElementById('importantDateTime').value;
    const eventInput = document.getElementById('importantDateEvent').value;

    if (dateInput && timeInput && eventInput) {
        const fullDate = `${dateInput}T${timeInput}`; 
        const newDate = {
            id: generateUUID(), 
            datetime: new Date(fullDate).toISOString(),
            event: eventInput
        };
        importantDates.push(newDate); 
        importantDates.sort((a, b) => new Date(a.datetime) - new Date(b.datetime)); 
        saveImportantDatesToStorage();
        updateImportantDatesDisplay();
        logActivity(`Added important date: ${eventInput} on ${new Date(fullDate).toLocaleString()}`);
        showNotification("Important date added!");

        // Clear inputs
        document.getElementById('importantDateDay').value = new Date().toISOString().split('T')[0];
        document.getElementById('importantDateTime').value = "09:00";
        document.getElementById('importantDateEvent').value = '';
    } else {
        showError("Please fill in all important date fields.");
    }
}
// New function: Add an important date from a bot command
function addImportantDateFromBot(date, time, description) {
    const fullDate = `${date}T${time}`;
    try {
        const eventDate = new Date(fullDate);
        if (isNaN(eventDate.getTime())) {
            showNotification("Invalid date/time for bot event.", "error");
            logError(`Bot tried to add event with invalid date/time: ${fullDate}`);
            return;
        }
        const newDate = {
            id: generateUUID(),
            datetime: eventDate.toISOString(),
            event: description
        };
        importantDates.push(newDate);
        importantDates.sort((a, b) => new Date(a.datetime) - new Date(b.datetime));
        saveImportantDatesToStorage();
        updateImportantDatesDisplay();
        logActivity(`Bot added important date: ${description} on ${eventDate.toLocaleString()}`);
        showNotification(`Bot added event: ${description} for ${eventDate.toLocaleDateString()}`);
    } catch (e) {
        showNotification("Failed to add bot event.", "error");
        logError(`Error adding bot event (${fullDate}, ${description}): ${e.message}`);
    }
}

function clearImportantDates() {
    if (confirm("Are you sure you want to clear all important dates?")) {
        importantDates = [];
        saveImportantDatesToStorage();
        updateImportantDatesDisplay();
        logActivity("All important dates cleared by user or bot command.");
        showNotification("All important dates cleared.");
    }
}

function updateImportantDatesDisplay() {
    const container = document.getElementById('importantDatesList');
    if (!container) return;
    container.innerHTML = '';

    importantDates.forEach(dateEntry => {
        const entryElement = document.createElement('div');
        entryElement.className = 'important-date-item';
        const formattedDate = new Date(dateEntry.datetime).toLocaleString();
        entryElement.innerHTML = `
            <div class="date-time">${formattedDate}</div>
            <div class="event-description">${dateEntry.event}</div>
        `;
        container.appendChild(entryElement);
    });
}


// New Mouse Clicker functions
function incrementClickCounter() {
    clickCount++;
    updateClickCountDisplay();
    saveClickCountToStorage();
    logActivity('Mouse click incremented');
}

function resetClickCounter() {
    if (confirm("Are you sure you want to reset the click counter?")) {
        clickCount = 0;
        updateClickCountDisplay();
        saveClickCountToStorage();
        logActivity('Mouse clicker reset by user or bot command.');
        showNotification("Click counter reset!");
    }
}
// New function: Set click counter from bot command
function setClickCounter(count) {
    if (typeof count === 'number' && !isNaN(count) && count >= 0) {
        clickCount = Math.floor(count);
        updateClickCountDisplay();
        saveClickCountToStorage();
        logActivity(`Click counter set to ${count} by bot command.`);
        showNotification(`Click counter set to ${count}!`);
    } else {
        showNotification("Invalid click count for bot command.", "error");
        logError(`Bot tried to set invalid click count: ${count}`);
    }
}


function updateClickCountDisplay() {
    const display = document.getElementById('clickCountDisplay');
    if (display) {
        display.textContent = clickCount;
    }
}

// Function to collect all current stats into a single object for sending to bot
function getCombinedStatsPayload() {
    const elapsedSeconds = stats.sessionStartTime ? Math.floor((Date.now() - stats.sessionStartTime) / 1000) : 0;
    const sessionHours = Math.floor(elapsedSeconds / 3600);
    const sessionMinutes = Math.floor((elapsedSeconds % 3600) / 60);
    const sessionSeconds = elapsedSeconds % 60;
    const formattedSessionTime = `${sessionHours.toString().padStart(2, '0')}:${sessionMinutes.toString().padStart(2, '0')}:${sessionSeconds.toString().padStart(2, '0')}`;

    return {
        username: currentUser,
        userID: currentUserID,
        buttonPresses: stats.buttonPresses,
        toggleSwitches: stats.toggleSwitches,
        panelsOpened: stats.panelsOpened,
        panelsClosed: stats.panelsClosed,
        searchQueries: stats.searchQueries,
        sessionTime: formattedSessionTime,
        mouseClicks: clickCount,
        activityLogEntries: activityLogs.length,
        errorLogEntries: errorLogs.length,
        loginHistoryEntries: loginHistory.length,
        importantDatesEntries: importantDates.length,
        currentTime: new Date().toLocaleString()
    };
}


function updateStats() {
  document.getElementById('buttonPresses').textContent = stats.buttonPresses;
  document.getElementById('toggleSwitches').textContent = stats.toggleSwitches;
  document.getElementById('panelsOpened').textContent = stats.panelsOpened;
  document.getElementById('panelsClosed').textContent = stats.panelsClosed;
  document.getElementById('searchQueries').textContent = stats.searchQueries;
}

function downloadActivityLogs() {
  const data = {
    activityLogs,
    loginHistory, 
    importantDates,
    mouseClickCount: clickCount,
    errorLogs,
    systemUpdates, 
    notifications, 
    stats,
    timestamp: new Date().toISOString()
  };
  
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `activity_logs_${new Date().toISOString().split('T')[0]}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  stats.buttonPresses++;
  logActivity('Activity logs downloaded by user.');
  showNotification('Activity logs downloaded!');
  updateStats();
}

function showStats() {
  togglePanel('statsPanel');
  
  // Create stats chart
  const ctx = document.getElementById('statsChart').getContext('2d');
  if (Chart.getChart(ctx)) {
    Chart.getChart(ctx).destroy();
  }
  new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['Button Presses', 'Toggle Switches', 'Panels Opened', 'Panels Closed', 'Search Queries', 'Mouse Clicks'],
      datasets: [{
        data: [stats.buttonPresses, stats.toggleSwitches, stats.panelsOpened, stats.panelsClosed, stats.searchQueries, clickCount],
        backgroundColor: ['#ff4500', '#ff6b35', '#00ff41', '#ffaa00', '#0066cc', '#8800cc'] 
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          labels: {
            color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary')
          }
        }
      }
    }
  });
}

// Timer functions
function startStopwatch() {
  if (!isStopwatchRunning) {
    isStopwatchRunning = true;
    stopwatchInterval = setInterval(() => {
      stopwatchTime++;
      updateStopwatchDisplay();
    }, 10);
    logActivity('Stopwatch started');
  }
}

function pauseStopwatch() {
  if (isStopwatchRunning) {
    isStopwatchRunning = false;
    clearInterval(stopwatchInterval);
    logActivity('Stopwatch paused');
  }
}

function resetStopwatch() {
  isStopwatchRunning = false;
  clearInterval(stopwatchInterval);
  stopwatchTime = 0;
  updateStopwatchDisplay();
  logActivity('Stopwatch reset');
}

function updateStopwatchDisplay() {
  const totalSeconds = Math.floor(stopwatchTime / 100);
  const hours = Math.floor(totalSeconds / 3600);
  const minutes = Math.floor((totalSeconds % 3600) / 60);
  const seconds = totalSeconds % 60;
  const centiseconds = stopwatchTime % 100;
  
  document.getElementById('stopwatchDisplay').textContent = 
    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}.${centiseconds.toString().padStart(2, '0')}`;
}

function startTimer() {
  const hours = parseInt(document.getElementById('timerHours').value) || 0;
  const minutes = parseInt(document.getElementById('timerMinutes').value) || 0;
  const seconds = parseInt(document.getElementById('timerSeconds').value) || 0;
  
  timerTime = (hours * 3600) + (minutes * 60) + seconds;
  
  if (timerTime > 0 && !isTimerRunning) {
    isTimerRunning = true;
    timerInterval = setInterval(() => {
      timerTime--;
      updateTimerDisplay();
      
      if (timerTime <= 0) {
        pauseTimer();
        showNotification('Timer finished!');
        logActivity('Timer completed');
      }
    }, 1000);
    logActivity('Timer started');
  }
}

function pauseTimer() {
  isTimerRunning = false;
  clearInterval(timerInterval);
  logActivity('Timer paused');
}

function resetTimer() {
  isTimerRunning = false;
  clearInterval(timerInterval);
  timerTime = 0;
  updateTimerDisplay();
  logActivity('Timer reset');
}

function updateTimerDisplay() {
  const hours = Math.floor(timerTime / 3600);
  const minutes = Math.floor((timerTime % 3600) / 60);
  const seconds = timerTime % 60;
  
  document.getElementById('timerDisplay').textContent = 
    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

function addReminder() {
  const text = document.getElementById('reminderText').value;
  const time = document.getElementById('reminderTime').value;
  
  if (text && time) {
    const reminderTime = new Date(time);
    const now = new Date();
    
    if (reminderTime > now) {
      const timeout = reminderTime.getTime() - now.getTime();
      
      setTimeout(() => {
        showNotification(`Reminder: ${text}`);
        addNotification(`Reminder: ${text}`); 
      }, timeout);
      
      const reminderElement = document.createElement('div');
      reminderElement.className = 'p-2 bg-gray-700 rounded';
      reminderElement.innerHTML = `
        <div class="font-semibold">${text}</div>
        <div class="text-sm text-gray-400">${reminderTime.toLocaleString()}</div>
      `;
      
      document.getElementById('remindersList').appendChild(reminderElement);
      
      document.getElementById('reminderText').value = '';
      document.getElementById('reminderTime').value = '';
      
      logActivity(`Reminder set: ${text}`);
    }
  }
}

// Drawing tools
function selectTool(button, tool) {
  document.querySelectorAll('.tool-btn[data-tool]').forEach(btn => btn.classList.remove('active'));
  button.classList.add('active');
  currentTool = tool;
  
  const canvas = document.getElementById('drawingCanvas');
  canvas.style.cursor = tool === 'eraser' ? 'crosshair' : 'crosshair';
  
  logActivity(`Drawing tool changed to: ${tool}`);
}

function clearCanvas() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  logActivity('Canvas cleared');
}

function saveCanvas() {
  const link = document.createElement('a');
  link.download = `drawing_${Date.now()}.png`;
  link.href = canvas.toDataURL();
  link.click();
  logActivity('Canvas saved');
}

function updateTextNotesDisplay() {
    const notes = localStorage.getItem('textNotes');
    if (notes) {
        document.getElementById('textNotes').value = notes;
    }
}


// Calculator functions
function appendToCalc(value) {
  const display = document.getElementById('calcDisplay');
  if (display.textContent === '0' && value !== '.') { 
    display.textContent = value;
  } else {
    display.textContent += value;
  }
}

function clearCalc() {
  document.getElementById('calcDisplay').textContent = '0';
}

function deleteLast() {
  const display = document.getElementById('calcDisplay');
  if (display.textContent.length > 1) {
    display.textContent = display.textContent.slice(0, -1);
  } else {
    display.textContent = '0';
  }
}

function calculateResult() {
  const display = document.getElementById('calcDisplay');
  try {
    const result = eval(display.textContent.replace('', '*').replace('', '/')); 
    display.textContent = result;
    logActivity(`Calculation performed: ${display.textContent} = ${result}`);
  } catch (error) {
    display.textContent = 'Error';
  }
}

// Unit converter
function updateConversionUnits() {
  const type = document.getElementById('conversionType').value;
  const fromUnit = document.getElementById('fromUnit');
  const toUnit = document.getElementById('toUnit');
  
  const units = {
    length: [
      { value: 'm', text: 'Meters' },
      { value: 'km', text: 'Kilometers' },
      { value: 'cm', text: 'Centimeters' },
      { value: 'mm', text: 'Millimeters' },
      { value: 'in', text: 'Inches' },
      { value: 'ft', text: 'Feet' }
    ],
    weight: [
      { value: 'kg', text: 'Kilograms' },
      { value: 'g', text: 'Grams' },
      { value: 'lb', text: 'Pounds' },
      { value: 'oz', text: 'Ounces' }
    ],
    temperature: [
      { value: 'c', text: 'Celsius' },
      { value: 'f', text: 'Fahrenheit' },
      { value: 'k', text: 'Kelvin' }
    ],
    volume: [
      { value: 'l', text: 'Liters' },
      { value: 'ml', text: 'Milliliters' },
      { value: 'gal', text: 'Gallons' },
      { value: 'qt', text: 'Quarts' }
    ]
  };
  
  fromUnit.innerHTML = '';
  toUnit.innerHTML = '';
  
  units[type].forEach(unit => {
    fromUnit.innerHTML += `<option value="${unit.value}">${unit.text}</option>`;
    toUnit.innerHTML += `<option value="${unit.value}">${unit.text}</option>`;
  });
  convertUnits(); 
}

function convertUnits() {
  const fromValue = parseFloat(document.getElementById('fromValue').value);
  const fromUnit = document.getElementById('fromUnit').value;
  const toUnit = document.getElementById('toUnit').value;
  const type = document.getElementById('conversionType').value;
  
  if (isNaN(fromValue)) {
    document.getElementById('toValue').value = '';
    return;
  }
  
  let result = fromValue;
  
  const factors = {
    length: { 
      'm': 1, 'km': 1000, 'cm': 0.01, 'mm': 0.001, 'in': 0.0254, 'ft': 0.3048
    },
    weight: { 
      'kg': 1000, 'g': 1, 'lb': 453.592, 'oz': 28.3495
    },
    temperature: { 
    },
    volume: { 
        'l': 1, 'ml': 0.001, 'gal': 3.78541, 'qt': 0.946353
    }
  };
  
  if (type === 'length') {
    result = fromValue * factors.length[fromUnit] / factors.length[toUnit];
  } else if (type === 'weight') {
    result = fromValue * factors.weight[fromUnit] / factors.weight[toUnit];
  } else if (type === 'volume') {
    result = fromValue * factors.volume[fromUnit] / factors.volume[toUnit];
  } else if (type === 'temperature') {
      let tempInC;
      if (fromUnit === 'c') tempInC = fromValue;
      else if (fromUnit === 'f') tempInC = (fromValue - 32) * 5/9;
      else if (fromUnit === 'k') tempInC = fromValue - 273.15;

      if (toUnit === 'c') result = tempInC;
      else if (toUnit === 'f') result = (tempInC * 9/5) + 32;
      else if (toUnit === 'k') result = tempInC + 273.15;
  }
  
  document.getElementById('toValue').value = result.toFixed(6);
  logActivity(`Unit converted: ${fromValue} ${fromUnit} to ${result.toFixed(6)} ${toUnit}`);
}

// Theme functions
function toggleTheme() {
  document.body.classList.toggle('light-theme');
  isLightMode = document.body.classList.contains('light-theme');
  logActivity('Theme toggled to ' + (isLightMode ? 'Light Mode' : 'Dark Mode'));
  updateStatsChartTheme(); 

  // Adjust eraser color for dark/light modes on canvas
  if (currentTool === 'eraser') {
      ctx.strokeStyle = isLightMode ? getComputedStyle(document.documentElement).getPropertyValue('--primary-bg') : 'white';
  }
}

function applyAccentTheme(themeName, event = null) {
  const root = document.documentElement;
  
  const themes = {
    orange: { primary: '#ff4500', secondary: '#ff6b35' },
    blue: { primary: '#0066cc', secondary: '#004499' },
    green: { primary: '#00cc44', secondary: '#009933' },
    red: { primary: '#cc0044', secondary: '#990033' },
    purple: { primary: '#8800cc', secondary: '#6600aa' },
    amber: { primary: '#ffaa00', secondary: '#ff8800' },
    teal: { primary: '#00aaaa', secondary: '#008888' },
    pink: { primary: '#ff0088', secondary: '#cc0066' }
  };
  
  if (themes[themeName]) {
    root.style.setProperty('--accent-color', themes[themeName].primary);
    root.style.setProperty('--accent-secondary', themes[themeName].secondary);
    
    if (document.body.classList.contains('light-theme')) {
        root.style.setProperty('--success-color', themes[themeName].primary); 
        root.style.setProperty('--error-color', themes[themeName].primary);   
        root.style.setProperty('--warning-color', themes[themeName].primary); 
    } else {
        root.style.setProperty('--success-color', '#00ff41'); 
        root.style.setProperty('--error-color', '#ff0040');   
        root.style.setProperty('--warning-color', '#ffaa00');
    }

    document.querySelectorAll('.theme-option').forEach(opt => opt.classList.remove('active'));
    if(event && event.target) { 
      event.target.classList.add('active'); 
    } else { 
        const matchingThemeOption = Array.from(document.querySelectorAll('.theme-option'))
                                        .find(opt => opt.textContent.toLowerCase() === themeName.toLowerCase());
        if(matchingThemeOption) matchingThemeOption.classList.add('active');
    }
    
    logActivity(`Accent theme changed to: ${themeName}`);
    updateStatsChartTheme(); 
  }
}

// Function to set accent color from bot (allows custom hex too)
function setDashboardAccentColor(color) {
    const root = document.documentElement;
    root.style.setProperty('--accent-color', color);
    root.style.setProperty('--accent-secondary', color); 
    
    if (document.body.classList.contains('light-theme')) {
        root.style.setProperty('--success-color', color); 
        root.style.setProperty('--error-color', color);   
        root.style.setProperty('--warning-color', color); 
    } else {
        root.style.setProperty('--success-color', '#00ff41'); 
        root.style.setProperty('--error-color', '#ff0040');   
        root.style.setProperty('--warning-color', '#ffaa00');
    }

    document.querySelectorAll('.theme-option').forEach(opt => opt.classList.remove('active')); 
    logActivity(`Dashboard accent color set by bot to: ${color}`);
    showNotification(`Dashboard color set to ${color}`);
    updateStatsChartTheme();
}


function updateStatsChartTheme() {
    const chart = Chart.getChart('statsChart');
    if (chart) {
        chart.options.plugins.legend.labels.color = getComputedStyle(document.documentElement).getPropertyValue('--text-primary');
        chart.update();
    }
}


function toggleSetting(toggle) {
  toggle.classList.toggle('active');
  stats.toggleSwitches++;
  logActivity(`Setting toggled: ${toggle.previousElementSibling.textContent}`);
  updateStats();
}

// Refresh functions
function refreshFact() {
  const facts = [
    "Honey never spoils. Archaeologists have found pots of honey in ancient Egyptian tombs that are over 3000 years old and still perfectly edible.",
    "A group of flamingos is called a 'flamboyance'.",
    "Bananas are berries, but strawberries aren't.",
    "The shortest war in history lasted only 38-45 minutes.",
    "A single cloud can weigh more than a million pounds."
  ];
  
  document.getElementById('randomFact').textContent = facts[Math.floor(Math.random() * facts.length)];
  logActivity('Random fact refreshed');
}

function refreshQuote() {
  const quotes = [
    "\"The only way to do great work is to love what you do.\" - Steve Jobs",
    "\"Innovation distinguishes between a leader and a follower.\" - Steve Jobs",
    "\"Life is what happens to you while you're busy making other plans.\" - John Lennon",
    "\"The future belongs to those who believe in the beauty of their dreams.\" - Eleanor Roosevelt",
    "\"It is during our darkest moments that we must focus to see the light.\" - Aristotle"
  ];
  
  document.getElementById('dailyQuote').textContent = quotes[Math.floor(Math.random() * quotes.length)];
  logActivity('Daily quote refreshed');
}

function clearNotifications() {
  if (confirm("Are you sure you want to clear all notifications?")) {
      notifications = [];
      localStorage.removeItem('notifications'); 
      updateNotificationsDisplay();
      logActivity('Notifications cleared by user or bot command.');
      showNotification('Notifications cleared!');
  }
}

function clearActivityLogs() {
  if (confirm("Are you sure you want to clear all activity logs?")) {
    activityLogs = [];
    localStorage.removeItem('activityLogs'); 
    updateActivityLogDisplay();
    logActivity('Activity logs cleared by user or bot command.');
    showNotification('Activity logs cleared!');
  }
}

function clearTextNotes() {
  if (confirm("Are you sure you want to clear your text notes?")) {
    document.getElementById('textNotes').value = '';
    localStorage.removeItem('textNotes');
    logActivity('Text notes cleared by user or bot command.');
    showNotification('Text notes cleared!');
  }
}

// Function to clear all local storage data. Triggered by ClearAll command
function clearAllClientData() {
    if (confirm("Are you sure you want to clear ALL locally stored data? This cannot be undone!")) {
        localStorage.clear();
        sessionStorage.clear(); 
        location.reload(); 
        logActivity('All local client data cleared by bot command, system reloaded.');
    }
}


function showNotification(message, type = 'info') {
  const notification = document.createElement('div');
  notification.className = 'notification';
  notification.innerHTML = `<i class="fas fa-info-circle"></i> ${message}`;
  
  if (type === 'error') {
    notification.style.borderColor = 'var(--error-color)';
    notification.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
  } else if (type === 'warning') {
    notification.style.borderColor = 'var(--warning-color)';
    notification.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${message}`;
  }
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.remove();
  }, 3000);
  addNotification(message); 
}

function logout(force = false) {
  if (force || confirm('Are you sure you want to logout?')) {
    logActivity('System logged out by user or bot command.');
    
    // Notify Flask backend of logout
    if (socket && socket.connected && currentUser) {
        socket.emit('user_disconnected_session', {
            username: currentUser,
            userID: currentUserID,
            sessionId: currentSessionId
        });
        // Disconnect immediately. The Flask backend will also detect this disconnect.
        socket.disconnect(); 
    } else if (currentUser) {
        console.warn("User attempted logout but socket not connected, no graceful disconnect notification sent to backend.");
    }

    // Clear session info from local storage when logging out
    localStorage.removeItem('currentUser');
    localStorage.removeItem('currentUserID');
    localStorage.removeItem('currentSessionId');

    localStorage.removeItem('textNotes'); 
    localStorage.removeItem('mouseClickCount'); 
    
    // Important: DO NOT clear `loginHistory` on regular logout if you want to keep historical login logs.
    
    location.reload(); 
  }
}

// New functions requested by user
function sendPanicSignal(url) {
    window.open(url, '_blank');
    logActivity(`User initiated panic redirect to ${url}`);
    showNotification(`Panicked to ${url}!`);
    stats.buttonPresses++;
    updateStats();
}

function captureScreenshotForBot() {
    html2canvas(document.body).then(function(canvas) {
        const imageData = canvas.toDataURL('image/png'); // Base64 image data
        sendClientDataToBot('take_screenshot', imageData, 'image');
        showNotification('Screenshot captured and sent to bot!', 'success');
        logActivity('Screenshot captured for bot.');
    });
    stats.buttonPresses++;
    updateStats();
}

function setCustomAnnouncement(message) {
    const announcementTextElement = document.getElementById('announcementText');
    if (announcementTextElement) {
        announcementTextElement.textContent = message;
        announcementTextElement.style.animation = 'none';
        void announcementTextElement.offsetWidth; 
        announcementTextElement.style.animation = 'marquee 20s linear infinite';
        showNotification(`Announcement set: ${message}`);
        logActivity(`Announcement set by bot: ${message}`);
    } else {
        showNotification("Failed to set announcement, element not found.", "error");
    }
}

function togglePanelsGridVisibility() {
    if (!panelsGrid) return; // Ensure panelsGrid element is defined
    if (panelsGrid.style.display === 'none' || panelsGrid.style.opacity === '0') {
        panelsGrid.style.display = 'grid';
        panelsGrid.style.opacity = '1';
        showNotification('Sections are now visible.');
        logActivity('Sections toggled ON by user or bot command.');
    } else {
        panelsGrid.style.opacity = '0'; 
        setTimeout(() => {
            panelsGrid.style.display = 'none';
        }, 300);
        showNotification('Sections are now hidden.');
        logActivity('Sections toggled OFF by user or bot command.');
    }
    stats.buttonPresses++;
    updateStats();
}

async function restartSystem() {
    if (confirm('Are you sure you want to restart the system? You will be logged out and all unsaved data will be lost.')) {
        logActivity('System restarted by user or bot command.');
        localStorage.clear(); 
        location.reload(); 
    }
}


// Event listeners
document.addEventListener('DOMContentLoaded', () => {
  setupToggles();
  
  submitBtn.addEventListener('click', (e) => {
    e.preventDefault();
    stats.buttonPresses++;
    attemptLogin();
  });

  resetBtn.addEventListener('click', resetCounter); 
  
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
        if (resetPopup.style.display === 'flex') { 
            resetCounter();
        } else if (!document.getElementById('loginScreen').classList.contains('hidden')) { 
            attemptLogin();
        }
    }
  });
  
  document.getElementById('penColor').addEventListener('change', (e) => {
    currentColor = e.target.value;
  });
  
  document.getElementById('penThickness').addEventListener('input', (e) => {
    currentThickness = parseInt(e.target.value);
  });
  
  document.addEventListener('click', (e) => {
    if ((e.target.tagName === 'BUTTON' && !e.target.closest('.panel-controls') && !e.target.classList.contains('submit-btn')) || e.target.closest('.quick-btn')) {
        stats.buttonPresses++;
        updateStats();
    }
  });
  // Set default values for Important Dates inputs (current date and a default time)
  const today = new Date();
  document.getElementById('importantDateDay').value = today.toISOString().split('T')[0];
  document.getElementById('importantDateTime').value = "09:00";

});
</script>

</body>
</html>
